package org.openmrs.module.eptsreports.reporting.library.cohorts;

import java.util.HashMap;
import java.util.Map;
import org.apache.commons.text.StringSubstitutor;

public class TPT_InitiationQueries {

  /**
   * Unique query to get TPT Initiation patients
   *
   * @return String
   */
  public static String getTPTInitiationPatients(
      int clinicalEncounter,
      int treatmentPrescribedConcept,
      int concept3HP,
      int regimeTPTEncounterType,
      int regimeTPTConcept,
      int piridoxina3HPConcept,
      int masterCardEncounterType,
      int dataInicioProfilaxiaIsoniazidaConcept,
      int isoniazidUsageConcept,
      int getStartDrugs,
      int pediatriaSeguimentoEncounterType,
      int isoniazidConcept,
      int isoniazidePiridoxinaConcept,
      int arvPharmaciaEncounterType,
      int arvPlanConcept,
      int arvStartDateConcept,
      int artProgram,
      int masterCardDrugPickupEncounterType,
      int artDatePickupMasterCard,
      int artPickupConcept,
      int yesConcept,
      int pregnantConcept,
      int arvAdultInitialEncounterType,
      int numberOfWeeksPregnant,
      int pregnancyDueDate,
      int criteriaForArtStart,
      int bPostiveConcept,
      int ptvEtvProgram,
      int dateOfLastMenstruationConcept,
      int priorDeliveryDateConcept,
      int breastfeedingConcept,
      int patientGaveBirthWorkflowState,
      int dtINHConcept,
      int continuaConcept,
      int typeDispensationTPTConceptUuid,
      int monthlyConcept,
      int quarterlyConcept,
      int completedConcept,
      int dataFinalizacaoProfilaxiaIsoniazidaConcept,
      int arvPediatriaInitialEncounterType,
      int dateOfMasterCardFileOpeningConcept,
      int hivCareProgram,
      int restartConcept,
      int treatmentFollowUp) {

    Map<String, Integer> valuesMap = new HashMap<>();
    valuesMap.put("6", clinicalEncounter);
    valuesMap.put("1719", treatmentPrescribedConcept);
    valuesMap.put("23954", concept3HP);
    valuesMap.put("60", regimeTPTEncounterType);
    valuesMap.put("23985", regimeTPTConcept);
    valuesMap.put("23984", piridoxina3HPConcept);
    valuesMap.put("53", masterCardEncounterType);
    valuesMap.put("6128", dataInicioProfilaxiaIsoniazidaConcept);
    valuesMap.put("6122", isoniazidUsageConcept);
    valuesMap.put("1256", getStartDrugs);
    valuesMap.put("9", pediatriaSeguimentoEncounterType);
    valuesMap.put("656", isoniazidConcept);
    valuesMap.put("23982", isoniazidePiridoxinaConcept);
    valuesMap.put("18", arvPharmaciaEncounterType);
    valuesMap.put("1255", arvPlanConcept);
    valuesMap.put("1190", arvStartDateConcept);
    valuesMap.put("2", artProgram);
    valuesMap.put("52", masterCardDrugPickupEncounterType);
    valuesMap.put("23866", artDatePickupMasterCard);
    valuesMap.put("23865", artPickupConcept);
    valuesMap.put("1065", yesConcept);
    valuesMap.put("1982", pregnantConcept);
    valuesMap.put("5", arvAdultInitialEncounterType);
    valuesMap.put("1279", numberOfWeeksPregnant);
    valuesMap.put("1600", pregnancyDueDate);
    valuesMap.put("6334", criteriaForArtStart);
    valuesMap.put("6331", bPostiveConcept);
    valuesMap.put("8", ptvEtvProgram);
    valuesMap.put("1465", dateOfLastMenstruationConcept);
    valuesMap.put("5599", priorDeliveryDateConcept);
    valuesMap.put("6332", breastfeedingConcept);
    valuesMap.put("27", patientGaveBirthWorkflowState);
    valuesMap.put("23955", dtINHConcept);
    valuesMap.put("1257", continuaConcept);
    valuesMap.put("23986", typeDispensationTPTConceptUuid);
    valuesMap.put("1098", monthlyConcept);
    valuesMap.put("23720", quarterlyConcept);
    valuesMap.put("1267", completedConcept);
    valuesMap.put("6129", dataFinalizacaoProfilaxiaIsoniazidaConcept);
    valuesMap.put("7", arvPediatriaInitialEncounterType);
    valuesMap.put("23891", dateOfMasterCardFileOpeningConcept);
    valuesMap.put("1", hivCareProgram);
    valuesMap.put("1705", restartConcept);
    valuesMap.put("23987", treatmentFollowUp);

    String query =
        "         SELECT p.person_id, nid.nid AS NID , p.gender, last_person_name.nome AS name,   "
            + "      CASE  WHEN p.birthdate IS NULL THEN 'N/A'   "
            + "       ELSE TIMESTAMPDIFF(YEAR,p.birthdate,:endDate)   "
            + "       END AS age,   "
            + "                initiated_art.first_pickup AS tarv_date, CASE   "
            + "                WHEN (pregnancy.pregnancy_date IS NULL AND breastfeeding. breastfeeding_date IS NULL) THEN 'N/A'   "
            + "                WHEN pregnancy.pregnancy_date IS NOT NULL THEN 'Grávida'   "
            + "                WHEN breastfeeding. breastfeeding_date IS NOT NULL THEN 'Lactante'   "
            + "                END AS pregnant_breastfeeding,   "
            + "                last_clinical.followup_date,   "
            + "                CASE  WHEN received_TPT.followup_date IS NULL THEN 'Não'   "
            + "                ELSE 'Sim' END AS received_TPT,   "
            + "                initiation_on_FILT.encounter_datetime AS 3HP_FILT_start_date,   "
            + "                initiation_on_clinical_sheet.encounter_datetime AS 3HP_clinical_start_date,   "
            + "                FILT_with_3HP.encounter_datetime AS FILT_3HP_dispensation_date,   "
            + "      CASE WHEN  FILT_3HP_dispensation.dispensation_type =${1098} THEN 'Mensal' "
            + "            WHEN  FILT_3HP_dispensation.dispensation_type =${23720} THEN 'Trimestral' "
            + "       ELSE ''   "
            + "       END AS FILT_3HP_dispensation_type,   "
            + "                IPT_initiation_on_FILT.pickup_date AS IPT_FILT_start_date,   "
            + "                IPT_clinical_seg_initiation.initiation_date AS IPT_clinical_seg_start_date,   "
            + "                IPT_mastercard_initiation.encounter_datetime AS IPT_mastercard_start_date,   "
            + "                FILT_with_IPT.encounter_datetime AS FILT_with_IPT_dispensation_date,   "
            + "                FILT_with_IPT_dispensation.dispensation_type AS FILT_with_IPT_dispensation_type,   "
            + "                IPT_completion.encounter_datetime AS IPT_end_date,   "
            + "                IPT_completion_mastercard.encounter_datetime AS IPT_mastercard_end_date,   "
            + "                IPT_expected_completion.expected_date AS IPT_expected_end_date,   "
            + "                expected_registered_date_difference.result AS expected_registered_date_difference   "
            + "                 FROM person p  "
            + "        JOIN (SELECT p.patient_id FROM patient p JOIN encounter e ON e.patient_id=p.patient_id   "
            + "                WHERE e.voided=0 AND p.voided=0 AND  e.encounter_type IN ( ${5} , ${7} )   "
            + "                AND e.encounter_datetime <=  :endDate   "
            + "                AND e.location_id = :location   "
            + "                UNION    "
            + "                SELECT p.patient_id FROM patient p   "
            + "                JOIN encounter e ON e.patient_id=p.patient_id   "
            + "                JOIN obs o ON e.encounter_id=o.encounter_id   "
            + "                WHERE e.voided=0 AND p.voided=0 AND o.voided=0 AND   "
            + "                e.encounter_type = ${53}   "
            + "                AND o.concept_id = ${23891}    "
            + "                AND o.value_datetime <=  :endDate   "
            + "                AND e.location_id = :location   "
            + "                UNION "
            + "                SELECT pg.patient_id FROM patient p JOIN patient_program pg ON p.patient_id=pg.patient_id   "
            + "                WHERE pg.voided=0 AND p.voided=0 AND program_id IN ( ${1} , ${2} ) AND pg.date_enrolled <=  :endDate AND location_id= :location  "
            + "                 ) base_cohort ON base_cohort.patient_id = p.person_id   "
            + "                 JOIN ( SELECT p.patient_id  "
            + "                          FROM  patient p  "
            + "                          INNER JOIN encounter e ON e.patient_id = p.patient_id       "
            + "                          INNER JOIN obs o ON o.encounter_id = e.encounter_id       "
            + "                          INNER JOIN (SELECT  p.patient_id, MIN(e.encounter_datetime) first_pickup_date      "
            + "                       FROM    patient p       "
            + "                       INNER JOIN encounter e ON e.patient_id = p.patient_id      "
            + "                       INNER JOIN obs o ON o.encounter_id = e.encounter_id       "
            + "                       WHERE   p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.location_id = :location      "
            + "                           AND e.encounter_type =   ${6} AND o.concept_id =   ${1719}       "
            + "                           AND o.value_coded IN ( ${23954} ) AND e.encounter_datetime >= :startDate     "
            + "                           AND e.encounter_datetime <= :endDate GROUP BY p.patient_id) AS pickup      "
            + "                       ON pickup.patient_id = p.patient_id     "
            + "                          WHERE p.patient_id NOT IN (    "
            + "                            SELECT patient_id       "
            + "                            FROM patient p      "
            + "                            WHERE p.voided = 0   AND e.voided = 0       "
            + "                                AND o.voided = 0   AND e.location_id = :location      "
            + "                                AND e.encounter_type =   ${6}  AND o.concept_id =   ${1719}       "
            + "                                AND o.value_coded IN ( ${23954} )      "
            + "                                AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)       "
            + "                                AND e.encounter_datetime < pickup.first_pickup_date   "
            + "                            UNION   "
            + "                            SELECT p.patient_id   "
            + "                            FROM patient p   "
            + "                                INNER JOIN encounter e ON p.patient_id = e.patient_id   "
            + "                                INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                            WHERE p.voided = 0 AND e.voided = 0  AND o.voided = 0 AND e.encounter_type=  ${60}    "
            + "                                AND (o.concept_id=  ${23985}   AND o.value_coded IN ( ${23954} , ${23984} ))   "
            + "                                AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)       "
            + "                                AND e.encounter_datetime < pickup.first_pickup_date)    "
            + "                       UNION    "
            + "                       SELECT p.patient_id     "
            + "                          FROM  patient p       "
            + "                          INNER JOIN encounter e ON e.patient_id = p.patient_id       "
            + "                          INNER JOIN obs o ON o.encounter_id = e.encounter_id       "
            + "                          INNER JOIN (SELECT  p.patient_id, MIN(e.encounter_datetime) first_pickup_date      "
            + "                       FROM    patient p       "
            + "                       INNER JOIN encounter e ON e.patient_id = p.patient_id      "
            + "                       INNER JOIN obs o ON o.encounter_id = e.encounter_id       "
            + "                       WHERE   p.voided = 0 AND e.voided = 0       "
            + "                           AND o.voided = 0   AND e.location_id = :location      "
            + "                           AND e.encounter_type =   ${60}       "
            + "                           AND o.concept_id =   ${23985}       "
            + "                           AND o.value_coded IN (${23954},${23984}  )      "
            + "                           AND e.encounter_datetime >= :startDate     "
            + "                           AND e.encounter_datetime <= :endDate     "
            + "                       GROUP BY p.patient_id) AS pickup      "
            + "                       ON pickup.patient_id = p.patient_id     "
            + "                          WHERE p.patient_id NOT IN ( SELECT patient_id       "
            + "                        FROM patient p      "
            + "                  WHERE p.voided = 0       "
            + "                             AND e.voided = 0 AND o.voided = 0       "
            + "                             AND e.location_id = :location      "
            + "                             AND e.encounter_type =   ${6}  AND o.concept_id =   ${23985}       "
            + "                             AND o.value_coded IN ( ${23954}  ,  ${23984} )      "
            + "                             AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)       "
            + "                             AND e.encounter_datetime < pickup.first_pickup_date   "
            + "                             UNION   "
            + "                            SELECT p.patient_id   "
            + "                            FROM patient p   "
            + "                                INNER JOIN encounter e ON p.patient_id = e.patient_id   "
            + "                                INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                            WHERE p.voided = 0 AND e.voided = 0   "
            + "                                AND o.voided = 0   "
            + "                                AND e.encounter_type= ${60}    "
            + "                                AND (o.concept_id=  ${23985}   AND o.value_coded IN ( ${23954} , ${23984} ))   "
            + "                                AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)       "
            + "                                AND e.encounter_datetime < pickup.first_pickup_date)   "
            + "                           UNION   "
            + "                            SELECT p.patient_id   "
            + "                            FROM patient p   "
            + "                                INNER JOIN encounter e ON p.patient_id = e.patient_id   "
            + "                                INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                                INNER JOIN obs o2 ON e.encounter_id = o2.encounter_id   "
            + "                            WHERE p.voided = 0 AND e.voided = 0   "
            + "                                AND o.voided = 0   "
            + "                                AND e.encounter_type=  ${60}    "
            + "                                AND (o.concept_id=  ${23985}   AND o.value_coded IN ( ${656}  , ${23982} ))   "
            + "                                AND (o2.concept_id=  ${23987}   AND o2.value_coded IN ( ${1256} , ${1705} ))   "
            + "                                AND e.encounter_datetime BETWEEN :startDate AND :endDate   "
            + "                                GROUP BY p.patient_id   "
            + "                           UNION     "
            + "                           SELECT p.patient_id FROM patient p      "
            + "                           JOIN encounter e ON e.patient_id = p.patient_id     "
            + "                           JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                           WHERE e.encounter_type =   ${53}   AND o.concept_id =   ${6128}       "
            + "                           AND o.voided = 0 AND e.voided = 0      "
            + "                           AND p.voided = 0 AND e.location_id = :location     "
            + "                           AND o.value_datetime IS NOT NULL     "
            + "                           AND o.value_datetime BETWEEN :startDate AND :endDate     "
            + "                           UNION     "
            + "                           SELECT p.patient_id FROM patient p      "
            + "                           JOIN encounter e ON e.patient_id = p.patient_id     "
            + "                           JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                           WHERE e.encounter_type =   ${6}   AND o.concept_id =   ${6122}       "
            + "                           AND o.voided = 0 AND e.voided = 0      "
            + "                           AND p.voided = 0 AND e.location_id = :location     "
            + "                           AND o.value_coded =   ${1256}       "
            + "                           AND e.encounter_datetime BETWEEN :startDate AND :endDate     "
            + "                           UNION     "
            + "                           SELECT p.patient_id FROM patient p      "
            + "                           JOIN encounter e ON e.patient_id = p.patient_id     "
            + "                           JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                           WHERE e.encounter_type IN (${6},${9}) AND o.concept_id = ${6128}       "
            + "                           AND o.voided = 0 AND e.voided = 0      "
            + "                           AND p.voided = 0 AND e.location_id = :location     "
            + "                           AND o.value_datetime IS NOT NULL     "
            + "                           AND o.value_datetime BETWEEN :startDate AND :endDate     "
            + "                           UNION    "
            + "                           SELECT p.patient_id   "
            + "                            FROM  patient p   "
            + "                                    INNER JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                                    INNER JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                                    INNER JOIN (SELECT  p.patient_id, MIN(e.encounter_datetime) first_pickup_date   "
            + "                                                FROM patient p INNER JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                                                    INNER JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                                                    INNER JOIN obs o2 on o2.encounter_id = e.encounter_id   "
            + "                                                WHERE   p.voided = 0  AND e.voided = 0   "
            + "                                                    AND o.voided = 0  AND e.location_id = :location   "
            + "                                                    AND e.encounter_type = ${60}    "
            + "                                                    AND (o.concept_id = ${23985}  AND o.value_coded IN (${656},${23982}))   "
            + "                                                    AND ((o2.concept_id =  ${23987}  AND (o2.value_coded =  ${1257}  OR o2.value_coded IS NULL))   "
            + "                                                    OR  o2.concept_id NOT IN( SELECT oo.concept_id FROM obs oo WHERE oo.voided = 0   "
            + "                                                                    AND oo.encounter_id = e.encounter_id   "
            + "                                                                    AND oo.concept_id =  ${23987}  ))   "
            + "                                                    AND e.encounter_datetime BETWEEN DATE_SUB(:endDate, INTERVAL 210 DAY) AND :endDate   "
            + "                                                GROUP BY p.patient_id) AS pickup   "
            + "                                                ON pickup.patient_id = p.patient_id   "
            + "                            WHERE p.patient_id NOT IN ( SELECT pp.patient_id   "
            + "                                FROM patient pp   "
            + "                                        INNER JOIN encounter ee ON ee.patient_id = pp.patient_id   "
            + "                                        INNER JOIN obs oo ON oo.encounter_id = ee.encounter_id   "
            + "                                WHERE pp.voided = 0   "
            + "                                AND p.patient_id = pp.patient_id   "
            + "                                AND ee.voided = 0   "
            + "                                AND oo.voided = 0   "
            + "                                AND ee.location_id = :location   "
            + "                                AND ee.encounter_type = ${60}    "
            + "                                AND oo.concept_id = ${23985}    "
            + "                                AND oo.value_coded IN ( ${656} ,  ${23982} )   "
            + "                                AND ee.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH)   "
            + "                                AND ee.encounter_datetime < pickup.first_pickup_date   "
            + "                                UNION   "
            + "                                SELECT p.patient_id FROM patient p   "
            + "                                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                                WHERE e.encounter_type = ${53}    AND o.concept_id = ${6128}    "
            + "                                AND o.voided = 0 AND e.voided = 0   "
            + "                                AND p.voided = 0 AND e.location_id = :location   "
            + "                                AND o.value_datetime IS NOT NULL   "
            + "                                AND o.value_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH)   "
            + "                                AND o.value_datetime < pickup.first_pickup_date   "
            + "                                UNION   "
            + "                                SELECT p.patient_id FROM patient p   "
            + "                                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                                WHERE e.encounter_type = ${6}    AND o.concept_id = ${6122}    "
            + "                                AND o.voided = 0 AND e.voided = 0   "
            + "                                AND p.voided = 0 AND e.location_id = :location   "
            + "                                AND o.value_coded = ${1256}    "
            + "                                AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH)   "
            + "                                AND e.encounter_datetime < pickup.first_pickup_date   "
            + "                                UNION   "
            + "                                SELECT p.patient_id FROM patient p   "
            + "                                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                                WHERE e.encounter_type IN (${6},${9}) AND o.concept_id = ${6128}    "
            + "                                AND o.voided = 0 AND e.voided = 0   "
            + "                                AND p.voided = 0 AND e.location_id = :location   "
            + "                                AND o.value_datetime IS NOT NULL   "
            + "                                AND o.value_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH)   "
            + "                                AND o.value_datetime < pickup.first_pickup_date)   "
            + "                            GROUP BY p.patient_id   "
            + "                            UNION   "
            + "                            SELECT p.patient_id FROM patient p   "
            + "                                INNER JOIN encounter e ON p.patient_id = e.patient_id   "
            + "                                INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                                INNER JOIN obs o2 ON e.encounter_id = o2.encounter_id   "
            + "                            WHERE p.voided = 0 AND e.voided = 0   "
            + "                                AND o.voided = 0   "
            + "                                AND e.encounter_type=   ${60}    "
            + "                                AND (o.concept_id=  ${23985}   AND o.value_coded IN (${656},${23982}))   "
            + "                                AND (o2.concept_id=  ${23987}   AND o2.value_coded IN ( ${1256} , ${1705} ))   "
            + "                                AND e.encounter_datetime BETWEEN :startDate AND :endDate   "
            + "                                GROUP BY p.patient_id  ) TPT ON TPT.patient_id = p.person_id   "
            + "       LEFT JOIN (SELECT   p.patient_id,( CASE  WHEN p.date_changed IS NOT NULL THEN (SELECT pi.identifier   "
            + "                                                      FROM   patient_identifier pi   "
            + "                                                      WHERE  pi.voided = 0 AND pi.patient_id = p.patient_id ORDER BY  pi.date_changed   DESC  LIMIT 1)   "
            + "                ELSE (SELECT pi.identifier  FROM   patient_identifier pi   "
            + "                      WHERE  pi.voided = 0 AND pi.patient_id = p.patient_id LIMIT 1) END ) AS nid   "
            + "      FROM    patient_identifier p WHERE    p.voided = 0 GROUP BY p.patient_id ) AS nid ON nid.patient_id = p.person_id   "
            + "       LEFT JOIN (SELECT p.person_id, ( CASE  WHEN p.date_changed IS NOT NULL THEN (SELECT Concat(pn.given_name, ' ', pn.family_name) AS person_name   "
            + "                                                      FROM   person_name pn  "
            + "                                                      WHERE  pn.voided = 0 AND pn.person_id = p.person_id ORDER BY  pn.date_changed   DESC  LIMIT 1)   "
            + "                ELSE (SELECT Concat(pn.given_name, ' ', pn.family_name) AS person_name  "
            + "                      FROM   person_name pn  WHERE  pn.voided = 0 AND pn.person_id = p.person_id LIMIT 1) END ) AS nome   "
            + "      FROM   person_name p INNER JOIN encounter e ON e.patient_id = p.person_id  "
            + "      WHERE  p.voided = 0 AND e.voided = 0 AND e.location_id = :location GROUP BY p.person_id ) AS last_person_name  ON last_person_name.person_id = p.person_id   "
            + "       LEFT JOIN ( SELECT union_tbl.patient_id , MIN(union_tbl.first_pickup) first_pickup FROM   "
            + "                (SELECT p.patient_id, first_pickup FROM patient p   "
            + "                JOIN   "
            + "                patient_program pp ON pp.patient_id = p.patient_id   "
            + "                JOIN   "
            + "                (SELECT p.patient_id, MIN(e.encounter_datetime) first_pickup FROM patient  p   "
            + "                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                WHERE e.encounter_type =  ${18}    "
            + "                AND e.voided = 0 AND p.voided = 0   "
            + "                AND o.voided = 0 AND e.location_id = :location   "
            + "                GROUP BY p.patient_id) first_pickup   "
            + "                ON first_pickup.patient_id = p.patient_id   "
            + "                JOIN   "
            + "                (SELECT p.patient_id FROM patient p   "
            + "                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                WHERE e.encounter_type IN ( ${6} , ${9} , ${18} )   "
            + "                AND o.concept_id =  ${1255}  AND o.value_coded = ${1256}    "
            + "                AND e.voided = 0 AND p.voided = 0   "
            + "                AND o.voided = 0 AND e.location_id = :location    "
            + "                AND e.encounter_datetime <= :startDate) arv_plan    "
            + "                ON arv_plan.patient_id = p.patient_id   "
            + "                GROUP BY p.patient_id   "
            + "                UNION   "
            + "                SELECT p.patient_id, MIN(o.obs_datetime) AS first_pickup FROM patient p   "
            + "                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                WHERE e.encounter_type IN ( ${6} , ${9} , ${18} , ${53} )   "
            + "                AND o.concept_id =  ${1190}     "
            + "                AND e.voided = 0 AND p.voided = 0   "
            + "                AND o.voided = 0 AND e.location_id = :location    "
            + "                AND o.obs_datetime <= :startDate   "
            + "                GROUP BY p.patient_id   "
            + "                UNION   "
            + "                SELECT p.patient_id, MIN(o.value_datetime) first_pickup FROM patient p    "
            + "                    JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                    JOIN obs oo ON oo.encounter_id = e.encounter_id   "
            + "                    WHERE e.encounter_type =  ${52}  AND e.location_id = :location   "
            + "                    AND e.voided = 0 AND p.voided = 0   "
            + "                    AND o.concept_id =   ${23866}  AND o.voided =0   "
            + "                    AND o.value_datetime <= :endDate   "
            + "                    GROUP BY p.patient_id   "
            + "                UNION   "
            + "                SELECT p.patient_id, pp.date_enrolled AS first_pickup FROM patient p   "
            + "                JOIN   "
            + "                patient_program pp ON pp.patient_id = p.patient_id   "
            + "                WHERE pp.program_id =  ${2}    "
            + "                AND pp.date_enrolled <= :endDate   "
            + "                AND p.voided = 0   "
            + "                GROUP BY p.patient_id) union_tbl "
            + "                GROUP BY union_tbl.patient_id) initiated_art "
            + "                ON initiated_art.patient_id = p.person_id "
            + "       LEFT JOIN ( Select max_pregnant.patient_id, pregnancy_date FROM  "
            + "                (SELECT pregnant.patient_id, MAX(pregnant.pregnancy_date) AS pregnancy_date FROM  "
            + "                 ( SELECT p.patient_id , MAX(e.encounter_datetime) AS pregnancy_date  "
            + "                     FROM patient p "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id  "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id  "
            + "                     WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=  ${1982} "
            + "                     AND value_coded=  ${1065}    "
            + "                     AND e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION  "
            + "                     SELECT p.patient_id, MAX(historical_date.value_datetime) as pregnancy_date FROM patient p "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "                     INNER JOIN obs pregnancy ON e.encounter_id=pregnancy.encounter_id "
            + "                     INNER JOIN obs historical_date ON e.encounter_id = historical_date.encounter_id     "
            + "                     WHERE p.voided=0 AND e.voided=0 AND pregnancy.voided=0 AND pregnancy.concept_id=  ${1982}    "
            + "                     AND pregnancy.value_coded= ${1065} "
            + "                     AND historical_date.voided=0 AND historical_date.concept_id=  ${1190} "
            + "                     AND historical_date.value_datetime IS NOT NULL "
            + "                     AND e.encounter_type = ${53} "
            + "                     AND historical_date.value_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION "
            + "                     SELECT p.patient_id,  MAX(e.encounter_datetime) as pregnancy_date "
            + "                     FROM patient p "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id  "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id  "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "                     WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id= ${1279}    "
            + "                     and  e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location  AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION "
            + "                     SELECT p.patient_id,  MAX(e.encounter_datetime) as pregnancy_date "
            + "                     FROM patient p "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id  "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id  "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id  "
            + "                     WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=  ${1600}    "
            + "                     and  e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION  "
            + "                     SELECT p.patient_id, MAX(e.encounter_datetime) as pregnancy_date     "
            + "                     FROM patient p  "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "                     WHERE p.voided=0 AND pe.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id= ${6334} "
            + "                     AND value_coded=  ${6331}    "
            + "                     AND e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION    "
            + "                     select pp.patient_id,  MAX(pp.date_enrolled) as pregnancy_date "
            + "                     FROM patient_program pp  "
            + "                     INNER JOIN person pe ON pp.patient_id=pe.person_id  "
            + "                     WHERE pp.program_id=  ${8} "
            + "                     AND pp.voided=0 AND pp.date_enrolled between  :startDate AND curdate() AND pp.location_id=:location AND pe.gender='F' GROUP BY pp.patient_id     "
            + "                     UNION "
            + "                     SELECT p.patient_id,  MAX(o.value_datetime) as pregnancy_date  FROM patient p     "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "       WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id= ${1465}    "
            + "                     AND e.encounter_type = ${6} "
            + "                     AND pe.gender='F' AND o.value_datetime BETWEEN :startDate AND curdate() GROUP BY p.patient_id) as pregnant "
            + "                     GROUP BY patient_id) max_pregnant "
            + "                    LEFT JOIN  (SELECT breastfeeding.patient_id, max(breastfeeding.last_date) as breastfeeding_date FROM ( "
            + "       SELECT p.patient_id, MAX(o.value_datetime) AS last_date     "
            + "       FROM patient p "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id  "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id  "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id   "
            + "       WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id= ${5599}    "
            + "       AND  e.encounter_type in (${5},${6})  AND o.value_datetime BETWEEN :startDate AND curdate()      "
            + "       AND e.location_id=:location AND pe.gender='F'     "
            + "       GROUP BY p.patient_id     "
            + "       UNION "
            + "       SELECT p.patient_id, MAX(e.encounter_datetime) AS last_date     "
            + "       FROM patient p     "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "       WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id= ${6332}    "
            + "       AND o.value_coded= ${1065}    "
            + "       AND e.encounter_type in (${5},${6}) "
            + "        AND e.encounter_datetime BETWEEN :startDate AND curdate() "
            + "           AND e.location_id=:location AND pe.gender='F'     "
            + "       GROUP BY p.patient_id    "
            + "       UNION "
            + "       SELECT p.patient_id, MAX(e.encounter_datetime) AS last_date     "
            + "       FROM patient p     "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "       WHERE p.voided=0 AND pe.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id= ${6334}    "
            + "       AND o.value_coded=  ${6332}    "
            + "       AND e.encounter_type in (${5},${6})  AND e.encounter_datetime BETWEEN :startDate AND curdate()      "
            + "       AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "       UNION "
            + "       SELECT pp.patient_id, MAX(ps.start_date) AS last_date     "
            + "       FROM patient_program pp     "
            + "       INNER JOIN person pe ON pp.patient_id=pe.person_id     "
            + "       INNER JOIN patient_state ps ON pp.patient_program_id=ps.patient_program_id     "
            + "       WHERE pp.program_id= ${8}    "
            + "       AND ps.state=  ${27}    "
            + "       AND pp.voided=0 AND  ps.start_date BETWEEN :startDate AND curdate()      "
            + "       AND pp.location_id=:location AND pe.gender='F'     "
            + "       GROUP BY pp.patient_id     "
            + "       UNION "
            + "       SELECT p.patient_id, MAX(hist.value_datetime) AS last_date     "
            + "       FROM patient p     "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "       INNER JOIN obs hist ON e.encounter_id=hist.encounter_id     "
            + "        WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id=  ${6332}    "
            + "       AND o.value_coded=  ${1065}    "
            + "       AND e.encounter_type = ${53}    "
            + "       AND hist.concept_id=   ${1190}    "
            + "       AND pe.gender='F' AND hist.value_datetime IS NOT NULL      "
            + "        AND hist.value_datetime BETWEEN :startDate AND curdate()  GROUP BY p.patient_id     "
            + "       ) AS breastfeeding     "
            + "       GROUP BY patient_id) max_breastfeeding     "
            + "                     ON max_pregnant.patient_id = max_breastfeeding.patient_id     "
            + "                     WHERE (max_pregnant.pregnancy_date Is NOT NULL AND max_pregnant.pregnancy_date >= max_breastfeeding.breastfeeding_date)     "
            + "                     OR (max_breastfeeding.breastfeeding_date Is NULL)    "
            + "                 )pregnancy ON pregnancy.patient_id = p.person_id   "
            + "                 LEFT JOIN   "
            + "                 ( Select max_breastfeeding.patient_id, breastfeeding_date FROM     "
            + "                  (SELECT breastfeeding.patient_id, max(breastfeeding.last_date) as breastfeeding_date FROM (     "
            + "       SELECT p.patient_id, MAX(o.value_datetime) AS last_date     "
            + "       FROM patient p     "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "       WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=  ${5599}    "
            + "       AND  e.encounter_type in (${5},${6})  AND o.value_datetime BETWEEN :startDate AND curdate()      "
            + "       AND e.location_id=:location AND pe.gender='F'     "
            + "       GROUP BY p.patient_id "
            + "       UNION  SELECT p.patient_id, MAX(e.encounter_datetime) AS last_date     "
            + "       FROM patient p "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "       WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id= ${6332}  "
            + "       AND o.value_coded= ${1065} "
            + "       AND e.encounter_type in (${5},${6}) "
            + "        AND e.encounter_datetime BETWEEN :startDate AND curdate() "
            + "           AND e.location_id=:location AND pe.gender='F' "
            + "       GROUP BY p.patient_id "
            + "       UNION "
            + "       SELECT p.patient_id, MAX(e.encounter_datetime) AS last_date     "
            + "       FROM patient p "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "       WHERE p.voided=0 AND pe.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id= ${6334} "
            + "       AND o.value_coded=  ${6332} "
            + "       AND e.encounter_type in (${5},${6}) "
            + "               AND e.encounter_datetime BETWEEN :startDate AND curdate() "
            + "            AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id "
            + "       UNION "
            + "       SELECT pp.patient_id, MAX(ps.start_date) AS last_date "
            + "       FROM patient_program pp "
            + "       INNER JOIN person pe ON pp.patient_id=pe.person_id "
            + "       INNER JOIN patient_state ps ON pp.patient_program_id=ps.patient_program_id     "
            + "       WHERE pp.program_id=  ${8} "
            + "       AND ps.state=  ${27} "
            + "       AND pp.voided=0 AND "
            + "         ps.start_date BETWEEN :startDate AND curdate() "
            + "           AND pp.location_id=:location AND pe.gender='F' "
            + "       GROUP BY pp.patient_id"
            + "                     UNION "
            + "       SELECT p.patient_id, MAX(hist.value_datetime) AS last_date "
            + "       FROM patient p "
            + "       INNER JOIN person pe ON p.patient_id=pe.person_id "
            + "       INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "       INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "       INNER JOIN obs hist ON e.encounter_id=hist.encounter_id "
            + "        WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND o.concept_id=  ${6332} "
            + "       AND o.value_coded=  ${1065} "
            + "       AND e.encounter_type = ${53} "
            + "       AND hist.concept_id=   ${1190} "
            + "       AND pe.gender='F' AND hist.value_datetime IS NOT NULL "
            + "        AND hist.value_datetime BETWEEN :startDate AND curdate() GROUP BY p.patient_id "
            + "       ) AS breastfeeding "
            + "       GROUP BY patient_id) max_breastfeeding "
            + "                    LEFT JOIN "
            + "                     (SELECT pregnant.patient_id, MAX(pregnant.pregnancy_date) AS pregnancy_date FROM "
            + "                 (SELECT p.patient_id , MAX(e.encounter_datetime) AS pregnancy_date "
            + "                     FROM patient p "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id  "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id "
            + "                     WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=  ${1982}    "
            + "                     AND value_coded=  ${1065}    "
            + "                     AND e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION     "
            + "                     SELECT p.patient_id, MAX(historical_date.value_datetime) as pregnancy_date FROM patient p     "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs pregnancy ON e.encounter_id=pregnancy.encounter_id     "
            + "                     INNER JOIN obs historical_date ON e.encounter_id = historical_date.encounter_id     "
            + "                     WHERE p.voided=0 AND e.voided=0 AND pregnancy.voided=0 AND pregnancy.concept_id=  ${1982}    "
            + "                     AND pregnancy.value_coded=   ${1065}    "
            + "                     AND historical_date.voided=0 AND historical_date.concept_id=  ${1190}    "
            + "                     AND historical_date.value_datetime IS NOT NULL     "
            + "                     AND e.encounter_type = ${53}    "
            + "                 AND historical_date.value_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION     "
            + "                     SELECT p.patient_id,  MAX(e.encounter_datetime) as pregnancy_date     "
            + "                     FROM patient p     "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "                     WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id= ${1279}    "
            + "                     and     "
            + "                     e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location  AND pe.gender='F' GROUP BY p.patient_id     "
            + "                     UNION "
            + "                     SELECT p.patient_id,  MAX(e.encounter_datetime) as pregnancy_date     "
            + "                     FROM patient p     "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "                     WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=  ${1600}    "
            + "                     and  e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id    "
            + "                     UNION "
            + "                     SELECT p.patient_id, MAX(e.encounter_datetime) as pregnancy_date     "
            + "                     FROM patient p     "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "                     WHERE p.voided=0 AND pe.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id= ${6334}    "
            + "                     AND value_coded=  ${6331}    "
            + "                     AND e.encounter_type in (${5},${6}) AND e.encounter_datetime between :startDate AND curdate() AND e.location_id=:location AND pe.gender='F' GROUP BY p.patient_id    "
            + " UNION "
            + "                     select pp.patient_id,  MAX(pp.date_enrolled) as pregnancy_date     "
            + "                     FROM patient_program pp     "
            + "                     INNER JOIN person pe ON pp.patient_id=pe.person_id     "
            + "                     WHERE pp.program_id=  ${8}    "
            + "                     AND pp.voided=0 AND pp.date_enrolled between  :startDate AND curdate() AND pp.location_id=:location AND pe.gender='F' GROUP BY pp.patient_id     "
            + "                     UNION   "
            + "                     SELECT p.patient_id,  MAX(o.value_datetime) as pregnancy_date  FROM patient p     "
            + "                     INNER JOIN person pe ON p.patient_id=pe.person_id     "
            + "                     INNER JOIN encounter e ON p.patient_id=e.patient_id     "
            + "                     INNER JOIN obs o ON e.encounter_id=o.encounter_id     "
            + "       WHERE p.voided=0 AND e.voided=0 AND o.voided=0 AND concept_id=  ${1465}    "
            + "                     AND e.encounter_type = ${6}    "
            + "                     AND pe.gender='F' AND o.value_datetime BETWEEN :startDate AND curdate() GROUP BY p.patient_id) as pregnant     "
            + "                     GROUP BY patient_id) max_pregnant   "
            + "                     ON max_pregnant.patient_id = max_breastfeeding.patient_id     "
            + "                     WHERE (max_breastfeeding.breastfeeding_date Is NOT NULL AND max_breastfeeding.breastfeeding_date > max_pregnant.pregnancy_date)     "
            + "                     OR (max_pregnant.pregnancy_date Is NULL) ) breastfeeding    "
            + "                     ON breastfeeding.patient_id = p.person_id    "
            + "                     LEFT JOIN   "
            + "                     (SELECT p.patient_id, MAX(e.encounter_datetime) AS followup_date FROM patient p    "
            + "                JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                WHERE e.encounter_type = ${6}  AND e.location_id = :location   "
            + "                AND e.voided = 0 AND p.voided = 0   "
            + "                AND e.encounter_datetime < curdate()   "
            + "                GROUP BY p.patient_id) last_clinical   "
            + "                ON last_clinical.patient_id = p.person_id   "
            + "                LEFT JOIN ( SELECT    p.patient_id, last_fu_consultation.followup_date as followup_date   "
            + "                FROM  patient p "
            + "                    JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "         INNER JOIN (SELECT p.patient_id, MAX(e.encounter_datetime) AS followup_date FROM patient p   "
            + "                 JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                 WHERE e.encounter_type = ${6}  AND e.location_id = :location   "
            + "                 AND e.voided = 0 AND p.voided = 0   "
            + "                 AND e.encounter_datetime < curdate() "
            + "                 GROUP BY p.patient_id   "
            + "                ) last_fu_consultation ON last_fu_consultation.patient_id = p.patient_id "
            + "                WHERE "
            + "                e.encounter_datetime = last_fu_consultation.followup_date "
            + "                AND e.encounter_type = ${6}  AND e.voided = 0 "
            + "                AND o.concept_id =  ${1719}  AND o.voided = 0 "
            + "                AND o.value_coded IN ( ${23954} , ${23955} ) "
            + "                AND e.encounter_datetime < curdate()   "
            + "                UNION  "
            + "                SELECT  p.patient_id, last_fu_consultation.followup_date as followup_date   "
            + "                FROM patient p   "
            + "                    JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "         INNER JOIN (SELECT p.patient_id, MAX(e.encounter_datetime) AS followup_date FROM patient p   "
            + "                 JOIN encounter e ON e.patient_id = p.patient_id "
            + "                 WHERE e.encounter_type = ${6}  AND e.location_id = :location  "
            + "                 AND e.voided = 0 AND p.voided = 0 "
            + "                 AND e.encounter_datetime < curdate() "
            + "                 GROUP BY p.patient_id   "
            + "                ) last_fu_consultation ON last_fu_consultation.patient_id = p.patient_id   "
            + "                WHERE   "
            + "                e.encounter_datetime = last_fu_consultation.followup_date   "
            + "                AND e.encounter_type = ${6}  AND e.voided = 0  "
            + "                AND o.concept_id = ${6122}  AND o.voided = 0  "
            + "                AND o.value_coded IN ( ${1256} , ${1257} ) "
            + "                AND e.encounter_datetime < curdate()   "
            + "                UNION "
            + "                SELECT   p.patient_id, last_fu_consultation.followup_date as followup_date   "
            + "                FROM  patient p   "
            + "                    JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "         INNER JOIN  (SELECT p.patient_id, MAX(e.encounter_datetime) AS followup_date FROM patient p   "
            + "                 JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                 WHERE e.encounter_type = ${6}  AND e.location_id = :location   "
            + "                 AND e.voided = 0 AND p.voided = 0   "
            + "                 AND e.encounter_datetime < curdate()   "
            + "                 GROUP BY p.patient_id ) last_fu_consultation ON last_fu_consultation.patient_id = p.patient_id   "
            + "                WHERE  e.encounter_datetime = last_fu_consultation.followup_date"
            + "                AND e.encounter_type = ${6}  AND e.voided = 0"
            + "                AND o.concept_id = ${6128}  AND o.voided = 0   "
            + "                AND e.encounter_datetime < curdate()   "
            + "                ) AS received_TPT ON received_TPT.patient_id = p.person_id   "
            + "                LEFT JOIN ( SELECT  p.patient_id, MAX(e.encounter_datetime) AS encounter_datetime   "
            + "                FROM   patient p   "
            + "         INNER JOIN  encounter e ON p.patient_id = e.patient_id "
            + "         INNER JOIN  obs o ON e.encounter_id = o.encounter_id "
            + "                WHERE   p.voided = 0 AND e.voided = 0 "
            + "         AND o.voided = 0   "
            + "         AND e.encounter_type = ${60}  "
            + "         AND e.location_id = :location "
            + "         AND o.concept_id = ${23985} "
            + "         AND o.value_coded IN ( ${23954}  ,  ${23984} ) "
            + "         AND e.encounter_datetime BETWEEN :startDate AND :endDate   "
            + "                GROUP BY p.patient_id   "
            + "                ) AS initiation_on_FILT ON initiation_on_FILT.patient_id = p.person_id   "
            + "                LEFT JOIN ( SELECT  p.patient_id,  MAX(e.encounter_datetime) AS encounter_datetime   "
            + "                FROM   patient p   "
            + "         INNER JOIN  encounter e ON p.patient_id = e.patient_id   "
            + "         INNER JOIN   obs o ON e.encounter_id = o.encounter_id   "
            + "                WHERE   p.voided = 0 AND e.voided = 0  AND o.voided = 0   "
            + "         AND e.encounter_type = ${6} "
            + "         AND e.location_id = :location "
            + "         AND o.concept_id =  ${1719} "
            + "         AND o.value_coded =  ${23954} "
            + "         AND e.encounter_datetime BETWEEN :startDate AND :endDate   "
            + "                GROUP BY p.patient_id   "
            + "                )AS initiation_on_clinical_sheet    "
            + "                ON initiation_on_clinical_sheet.patient_id = p.person_id   "
            + "                LEFT JOIN   "
            + "                (  SELECT  p.patient_id,  MAX(e.encounter_datetime) AS encounter_datetime   "
            + "                FROM  patient p   "
            + "         INNER JOIN encounter e ON p.patient_id = e.patient_id   "
            + "         INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                WHERE   p.voided = 0 AND e.voided = 0   "
            + "         AND o.voided = 0 "
            + "         and e.encounter_type=  ${60} "
            + "         and o.concept_id=  ${23985}  "
            + "         and o.value_coded in ( ${23954} ,  ${23984} ) "
            + "         and e.encounter_datetime <= curdate() "
            + "         GROUP BY p.patient_id "
            + "                ) AS FILT_with_3HP "
            + "                ON FILT_with_3HP.patient_id = p.person_id   "
            + "                LEFT JOIN   "
            + "                (  SELECT p.patient_id, o.value_coded AS dispensation_type FROM patient p   "
            + "                JOIN  encounter e ON e.patient_id = p.patient_id   "
            + "                JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                JOIN (SELECT p.patient_id, MAX(e.encounter_datetime) AS recent_filt "
            + "                FROM  patient p   "
            + "         INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + "         INNER JOIN  obs o ON o.encounter_id = e.encounter_id WHERE  p.voided = 0 AND e.voided = 0  AND o.voided = 0 "
            + "         AND e.encounter_type = ${60} "
            + "         AND o.concept_id = ${23985} "
            + "         AND o.value_coded IN ( ${23954},${23984} ) "
            + "         AND e.location_id = :location "
            + "         AND e.encounter_datetime <= CURDATE() "
            + "         GROUP BY p.patient_id "
            + "         ) AS latest_filt ON latest_filt.patient_id = p.patient_id   "
            + "         WHERE latest_filt.recent_filt = e.encounter_datetime "
            + "         AND o.concept_id =  ${23986} "
            + "         AND o.value_coded IN ( ${1098} , ${23720} ) "
            + "                ) AS FILT_3HP_dispensation ON FILT_3HP_dispensation.patient_id = p.person_id  "
            + "                LEFT JOIN ( SELECT  p.patient_id, MIN(e.encounter_datetime) AS pickup_date "
            + "                FROM  patient p "
            + "         INNER JOIN  encounter e ON p.patient_id = e.patient_id "
            + "         INNER JOIN   obs o ON e.encounter_id = o.encounter_id "
            + "                WHERE   p.voided = 0 AND e.voided = 0 AND o.voided = 0   "
            + "         AND e.encounter_type = ${60} "
            + "         AND o.concept_id = ${23985}   AND e.location_id = :location   "
            + "         AND o.value_coded IN (${656},${23982}) "
            + "         AND e.encounter_datetime BETWEEN :startDate AND  :endDate "
            + "                GROUP BY p.patient_id "
            + "                )AS IPT_initiation_on_FILT ON IPT_initiation_on_FILT.patient_id = p.person_id "
            + "                 LEFT JOIN  (  SELECT p.patient_id, "
            + "         CASE  WHEN o.concept_id = ${6122}  THEN MIN(e.encounter_datetime) "
            + "             WHEN o.concept_id = ${6128}  THEN MIN(o.value_datetime) "
            + "         END AS initiation_date "
            + "       FROM patient p  "
            + "             INNER JOIN  encounter e ON p.patient_id = e.patient_id "
            + "             INNER JOIN  obs o ON e.encounter_id = o.encounter_id "
            + "      WHERE p.voided = 0 AND e.voided = 0  "
            + "             AND o.voided = 0 AND e.location_id = :location "
            + "             AND e.encounter_type IN (${6} , ${9}) "
            + "             AND ((o.concept_id = ${6122} "
            + "             AND o.value_coded = ${1256} "
            + "             AND e.encounter_datetime BETWEEN :startDate AND  :endDate)  "
            + "             OR (o.concept_id = ${6128} "
            + "             AND o.value_datetime IS NOT NULL "
            + "             AND o.value_datetime BETWEEN :startDate AND  :endDate))  "
            + "      GROUP BY p.patient_id ) AS IPT_clinical_seg_initiation    "
            + "                 ON IPT_clinical_seg_initiation.patient_id = p.person_id   "
            + "                 LEFT JOIN  ( SELECT p.patient_id, MIN(o.value_datetime) AS encounter_datetime   "
            + "      FROM patient p  "
            + "      INNER JOIN encounter e ON e.patient_id = p.patient_id   "
            + "      INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "      WHERE e.encounter_type = ${53}  AND p.voided = 0  "
            + "      AND e.voided = 0  "
            + "      AND o.voided = 0  "
            + "      AND o.value_datetime IS NOT NULL "
            + "      AND o.concept_id = ${6128} "
            + "      AND e.location_id = :location "
            + "      AND o.value_datetime BETWEEN :startDate AND  :endDate  "
            + "                GROUP BY p.patient_id )IPT_mastercard_initiation    "
            + "                 ON IPT_mastercard_initiation.patient_id = p.person_id "
            + "                 LEFT JOIN (SELECT p.patient_id, MAX(e.encounter_datetime) AS encounter_datetime   "
            + "                    FROM patient p   "
            + "                    INNER JOIN encounter e ON e.patient_id = p.patient_id "
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id  "
            + "                    WHERE e.encounter_type = ${60}  AND p.voided = 0  "
            + "             AND e.voided = 0 "
            + "             AND o.voided = 0 "
            + "             AND o.concept_id = ${23985} "
            + "             AND o.value_coded IN (${656},${23982}) "
            + "             AND e.location_id = :location "
            + "             AND e.encounter_datetime <= CURDATE() GROUP BY p.patient_id   "
            + "                 ) FILT_with_IPT ON FILT_with_IPT.patient_id = p.person_id   "
            + "                 LEFT JOIN  (  SELECT   p.patient_id, o.value_coded AS dispensation_type FROM patient p "
            + "                JOIN encounter e ON e.patient_id = p.patient_id "
            + "                JOIN obs o ON o.encounter_id = e.encounter_id "
            + "                JOIN (SELECT p.patient_id, MAX(e.encounter_datetime) AS encounter_datetime "
            + "                    FROM patient p   "
            + "                    INNER JOIN encounter e ON e.patient_id = p.patient_id "
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                    WHERE e.encounter_type = ${60} AND p.voided = 0  "
            + "             AND e.voided = 0 "
            + "             AND o.voided = 0  "
            + "             AND o.concept_id = ${23985} "
            + "             AND o.value_coded IN (${656},${23982}) "
            + "             AND e.location_id = :location  "
            + "             AND e.encounter_datetime <= CURDATE() "
            + "                    GROUP BY p.patient_id ) AS latest_filt   "
            + "         ON latest_filt.patient_id = p.patient_id "
            + "         WHERE  latest_filt.encounter_datetime = e.encounter_datetime "
            + "         AND o.concept_id =  ${23986}  AND o.value_coded IN ( ${1098} , ${23720} )   "
            + "                 ) FILT_with_IPT_dispensation "
            + "                 ON FILT_with_IPT_dispensation.patient_id = p.person_id "
            + "                 LEFT JOIN (SELECT   fila.patient_id, MAX(fila.encounter_datetime) AS encounter_datetime   "
            + "                    FROM  (SELECT  p.patient_id, e.encounter_datetime "
            + "                    FROM   patient p   "
            + "                    INNER JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                    WHERE   e.encounter_type = ${6} "
            + "             AND p.voided = 0 AND e.voided = 0 "
            + "             AND o.voided = 0 AND o.concept_id = ${6122} "
            + "             AND o.value_coded = ${1267}  AND e.location_id = :location "
            + "             AND e.encounter_datetime <= CURDATE() "
            + "             UNION    "
            + "             SELECT p.patient_id, e.encounter_datetime "
            + "                    FROM  patient p   "
            + "                    INNER JOIN encounter e ON e.patient_id = p.patient_id "
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                    WHERE e.encounter_type IN (${6},${9}) AND p.voided = 0 "
            + "             AND e.voided = 0 AND o.voided = 0   "
            + "             AND o.concept_id = ${6129}  AND e.location_id = :location  "
            + "             AND e.encounter_datetime <= CURDATE()) AS fila "
            + "              GROUP BY fila.patient_id  )IPT_completion "
            + "                 ON IPT_completion.patient_id = p.person_id "
            + "                 LEFT JOIN  ( SELECT p.patient_id, MAX(o.value_datetime) AS encounter_datetime "
            + "      FROM  patient p  "
            + "      INNER JOIN encounter e ON e.patient_id = p.patient_id "
            + "      INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "      WHERE  e.encounter_type = ${53}    "
            + "      AND p.voided = 0  "
            + "      AND e.voided = 0  "
            + "      AND o.voided = 0  "
            + "      AND o.concept_id = ${6129}   "
            + "      AND e.location_id = :location  "
            + "      AND o.value_datetime <= CURDATE()  "
            + "                GROUP BY p.patient_id )IPT_completion_mastercard    "
            + "                 ON IPT_completion_mastercard.patient_id = p.person_id   "
            + "                 LEFT JOIN (SELECT    "
            + "                patient_id, DATE_ADD(MAX(consultation_date), INTERVAL 173 DAY) AS expected_date   "
            + "                FROM  (SELECT  p.patient_id, MIN(e.encounter_datetime) AS consultation_date   "
            + "                FROM  patient p   "
            + "         INNER JOIN  encounter e ON p.patient_id = e.patient_id   "
            + "         INNER JOIN  obs o ON e.encounter_id = o.encounter_id   "
            + "                WHERE  p.voided = 0 AND e.voided = 0   "
            + "         AND o.voided = 0   "
            + "         AND e.encounter_type = ${60}    "
            + "         AND o.concept_id = ${23985} AND e.location_id = :location   "
            + "         AND o.value_coded IN (${656},${23982})   "
            + "         AND e.encounter_datetime BETWEEN :startDate AND  :endDate   "
            + "                GROUP BY p.patient_id   "
            + "                UNION "
            + "           SELECT p.patient_id, CASE  "
            + "             WHEN o.concept_id = ${6122}  THEN MIN(e.encounter_datetime)  "
            + "             WHEN o.concept_id = ${6128}  THEN MIN(o.value_datetime)  "
            + "         END AS consultation_date  "
            + "      FROM  patient p  "
            + "             INNER JOIN  encounter e ON p.patient_id = e.patient_id  "
            + "             INNER JOIN obs o ON e.encounter_id = o.encounter_id  "
            + "      WHERE p.voided = 0 AND e.voided = 0  "
            + "             AND o.voided = 0 AND e.location_id = :location  "
            + "             AND e.encounter_type IN (${6} , ${9})  "
            + "             AND ((o.concept_id = ${6122}   "
            + "             AND o.value_coded = ${1256}   "
            + "             AND e.encounter_datetime BETWEEN :startDate AND  :endDate)  "
            + "             OR (o.concept_id = ${6128}   "
            + "             AND o.value_datetime IS NOT NULL  "
            + "             AND o.value_datetime BETWEEN :startDate AND  :endDate))  "
            + "      GROUP BY p.patient_id   "
            + "                UNION    "
            + "                 SELECT p.patient_id, o.value_datetime AS  consultation_date  "
            + "      FROM  patient p  "
            + "      INNER JOIN encounter e ON e.patient_id = p.patient_id  "
            + "      INNER JOIN obs o ON e.encounter_id = o.encounter_id  "
            + "      WHERE  e.encounter_type = ${53}  AND p.voided = 0  "
            + "      AND e.voided = 0  "
            + "      AND o.voided = 0  "
            + "      AND o.value_datetime IS NOT NULL  "
            + "      AND o.concept_id = ${6128}   "
            + "      AND e.location_id = :location  "
            + "      AND o.value_datetime BETWEEN :startDate AND :endDate  "
            + "                 ) union_tbl GROUP BY patient_id   "
            + "                 ) IPT_expected_completion    "
            + "                 ON IPT_expected_completion.patient_id = p.person_id   "
            + "                 LEFT JOIN ( SELECT p.patient_id, DATEDIFF(union_tbl.encounter_datetime, tbl_21.expected_date) AS result, union_tbl.encounter_datetime AS real_date,tbl_21.expected_date AS expected FROM patient p   "
            + "                JOIN (SELECT "
            + "         fila.patient_id, MAX(fila.encounter_datetime) AS encounter_datetime FROM   "
            + "         (SELECT  p.patient_id, e.encounter_datetime   "
            + "                    FROM patient p   "
            + "                    INNER JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                    WHERE e.encounter_type = ${6}     "
            + "             AND p.voided = 0 AND e.voided = 0   "
            + "             AND o.voided = 0 AND o.concept_id = ${6122}    "
            + "             AND o.value_coded = ${1267}  AND e.location_id = :location  "
            + "             AND e.encounter_datetime <= CURDATE()   "
            + "             UNION  "
            + "             SELECT p.patient_id, e.encounter_datetime   "
            + "                    FROM   patient p   "
            + "                    INNER JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                    INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                    WHERE e.encounter_type IN (${6},${9}) AND p.voided = 0   "
            + "             AND e.voided = 0 AND o.voided = 0   "
            + "             AND o.concept_id = ${6129}  AND e.location_id = :location   "
            + "             AND e.encounter_datetime <= CURDATE()   "
            + "             UNION "
            + "            SELECT p.patient_id, o.value_datetime AS encounter_datetime  "
            + "      FROM   patient p  "
            + "      INNER JOIN encounter e ON e.patient_id = p.patient_id  "
            + "      INNER JOIN obs o ON e.encounter_id = o.encounter_id  "
            + "      WHERE  e.encounter_type = ${53}    "
            + "      AND p.voided = 0  "
            + "      AND e.voided = 0  "
            + "      AND o.voided = 0  "
            + "      AND o.concept_id = ${6129} "
            + "      AND e.location_id = :location  "
            + "      AND o.value_datetime <= CURDATE() ) AS fila "
            + "              GROUP BY fila.patient_id) union_tbl   "
            + "              ON union_tbl.patient_id = p.patient_id   "
            + "              LEFT JOIN   "
            + "              (SELECT patient_id, DATE_ADD(MAX(consultation_date), INTERVAL 173 DAY) AS expected_date   "
            + "                FROM  (SELECT p.patient_id, MIN(e.encounter_datetime) AS consultation_date   "
            + "                FROM patient p   "
            + "         INNER JOIN encounter e ON p.patient_id = e.patient_id   "
            + "         INNER JOIN obs o ON e.encounter_id = o.encounter_id   "
            + "                WHERE p.voided = 0 AND e.voided = 0   "
            + "         AND o.voided = 0   "
            + "         AND e.encounter_type = ${60} "
            + "         AND o.concept_id = ${23985}  "
            + "         AND e.location_id = :location   "
            + "         AND o.value_coded IN (${656},${23982})   "
            + "         AND e.encounter_datetime BETWEEN :startDate AND  :endDate GROUP BY p.patient_id   "
            + "                UNION   "
            + "                SELECT p.patient_id, CASE  "
            + "             WHEN o.concept_id = ${6122}  THEN MIN(e.encounter_datetime)  "
            + "             WHEN o.concept_id = ${6128}  THEN MIN(o.value_datetime)  "
            + "         END AS consultation_date  "
            + "      FROM  patient p  "
            + "             INNER JOIN  encounter e ON p.patient_id = e.patient_id  "
            + "             INNER JOIN  obs o ON e.encounter_id = o.encounter_id  "
            + "      WHERE  p.voided = 0 AND e.voided = 0  "
            + "             AND o.voided = 0 AND e.location_id = :location  "
            + "             AND e.encounter_type IN (${6} , ${9})  "
            + "             AND ((o.concept_id = ${6122}   "
            + "             AND o.value_coded = ${1256}   "
            + "             AND e.encounter_datetime BETWEEN :startDate AND  :endDate)  "
            + "             OR (o.concept_id = ${6128}   "
            + "             AND o.value_datetime IS NOT NULL  "
            + "             AND o.value_datetime BETWEEN :startDate AND  :endDate)) GROUP BY p.patient_id   "
            + "                UNION   "
            + "      SELECT p.patient_id, o.value_datetime AS consultation_date  "
            + "      FROM patient p  "
            + "      INNER JOIN encounter e ON e.patient_id = p.patient_id  "
            + "      INNER JOIN obs o ON e.encounter_id = o.encounter_id  "
            + "      WHERE e.encounter_type = ${53}  AND p.voided = 0  "
            + "      AND e.voided = 0  "
            + "      AND o.voided = 0  "
            + "      AND o.value_datetime IS NOT NULL  "
            + "      AND o.concept_id = ${6128}   "
            + "      AND e.location_id = :location  "
            + "      AND o.value_datetime BETWEEN :startDate AND :endDate  ) union_tbl   "
            + "                    GROUP BY patient_id) tbl_21   "
            + "                    ON tbl_21.patient_id = p.patient_id) AS expected_registered_date_difference   "
            + "                 ON expected_registered_date_difference.patient_id = p.person_id   "
            + "                 WHERE p.voided=0 ";

    StringSubstitutor substitutor = new StringSubstitutor(valuesMap);
    return substitutor.replace(query);
  }

  /**
   * Query to get TPT Initiation TOTALS
   *
   * @return String
   */
  public static String getTPTInitiationTOTALS(
      int clinicalEncounter,
      int treatmentPrescribedConcept,
      int concept3HP,
      int regimeTPTEncounterType,
      int regimeTPTConcept,
      int piridoxina3HPConcept,
      int masterCardEncounterType,
      int dataInicioProfilaxiaIsoniazidaConcept,
      int isoniazidUsageConcept,
      int getStartDrugs,
      int pediatriaSeguimentoEncounterType,
      int isoniazidConcept,
      int isoniazidePiridoxinaConcept,
      int arvPharmaciaEncounterType,
      int arvPlanConcept,
      int arvStartDateConcept,
      int artProgram,
      int masterCardDrugPickupEncounterType,
      int artDatePickupMasterCard,
      int artPickupConcept,
      int yesConcept,
      int pregnantConcept,
      int arvAdultInitialEncounterType,
      int numberOfWeeksPregnant,
      int pregnancyDueDate,
      int criteriaForArtStart,
      int bPostiveConcept,
      int ptvEtvProgram,
      int dateOfLastMenstruationConcept,
      int priorDeliveryDateConcept,
      int breastfeedingConcept,
      int patientGaveBirthWorkflowState,
      int dtINHConcept,
      int continuaConcept,
      int typeDispensationTPTConceptUuid,
      int monthlyConcept,
      int quarterlyConcept,
      int completedConcept,
      int dataFinalizacaoProfilaxiaIsoniazidaConcept,
      int arvPediatriaInitialEncounterType,
      int dateOfMasterCardFileOpeningConcept,
      int hivCareProgram,
      int restartConcept,
      int treatmentFollowUp) {

    Map<String, Integer> valuesMap = new HashMap<>();
    valuesMap.put("6", clinicalEncounter);
    valuesMap.put("1719", treatmentPrescribedConcept);
    valuesMap.put("23954", concept3HP);
    valuesMap.put("60", regimeTPTEncounterType);
    valuesMap.put("23985", regimeTPTConcept);
    valuesMap.put("23984", piridoxina3HPConcept);
    valuesMap.put("53", masterCardEncounterType);
    valuesMap.put("6128", dataInicioProfilaxiaIsoniazidaConcept);
    valuesMap.put("6122", isoniazidUsageConcept);
    valuesMap.put("1256", getStartDrugs);
    valuesMap.put("9", pediatriaSeguimentoEncounterType);
    valuesMap.put("656", isoniazidConcept);
    valuesMap.put("23982", isoniazidePiridoxinaConcept);
    valuesMap.put("18", arvPharmaciaEncounterType);
    valuesMap.put("1255", arvPlanConcept);
    valuesMap.put("1190", arvStartDateConcept);
    valuesMap.put("2", artProgram);
    valuesMap.put("52", masterCardDrugPickupEncounterType);
    valuesMap.put("23866", artDatePickupMasterCard);
    valuesMap.put("23865", artPickupConcept);
    valuesMap.put("1065", yesConcept);
    valuesMap.put("1982", pregnantConcept);
    valuesMap.put("5", arvAdultInitialEncounterType);
    valuesMap.put("1279", numberOfWeeksPregnant);
    valuesMap.put("1600", pregnancyDueDate);
    valuesMap.put("6334", criteriaForArtStart);
    valuesMap.put("6331", bPostiveConcept);
    valuesMap.put("8", ptvEtvProgram);
    valuesMap.put("1465", dateOfLastMenstruationConcept);
    valuesMap.put("5599", priorDeliveryDateConcept);
    valuesMap.put("6332", breastfeedingConcept);
    valuesMap.put("27", patientGaveBirthWorkflowState);
    valuesMap.put("23955", dtINHConcept);
    valuesMap.put("1257", continuaConcept);
    valuesMap.put("23986", typeDispensationTPTConceptUuid);
    valuesMap.put("1098", monthlyConcept);
    valuesMap.put("23720", quarterlyConcept);
    valuesMap.put("1267", completedConcept);
    valuesMap.put("6129", dataFinalizacaoProfilaxiaIsoniazidaConcept);
    valuesMap.put("7", arvPediatriaInitialEncounterType);
    valuesMap.put("23891", dateOfMasterCardFileOpeningConcept);
    valuesMap.put("1", hivCareProgram);
    valuesMap.put("1705", restartConcept);
    valuesMap.put("23987", treatmentFollowUp);

    String query =
        " SELECT (SELECT name FROM location WHERE location_id = 398) AS location, COUNT(p.person_id) AS total, CONCAT(DATE_FORMAT(:startDate, '%d-%m-%Y'),' Até ',DATE_FORMAT(:endDate, '%d-%m-%Y')) AS period   "
            + "               FROM person p   "
            + "               JOIN (   "
            + "              SELECT p.patient_id FROM patient p JOIN encounter e ON e.patient_id=p.patient_id   "
            + "                       WHERE e.voided=0 AND p.voided=0 AND   "
            + "                       e.encounter_type IN ( ${5} , ${7} )   "
            + "                       AND e.encounter_datetime <=  :endDate   "
            + "                       AND e.location_id = :location  "
            + "                       UNION    "
            + "                       SELECT p.patient_id FROM patient p   "
            + "                       JOIN encounter e ON e.patient_id=p.patient_id   "
            + "                       JOIN obs o ON e.encounter_id=o.encounter_id   "
            + "                       WHERE e.voided=0 AND p.voided=0 AND o.voided=0 AND   "
            + "                       e.encounter_type =  ${53}   "
            + "                       AND o.concept_id = ${23891}    "
            + "                       AND o.value_datetime <=  :endDate   "
            + "                       AND e.location_id = :location  "
            + "                       UNION   "
            + "                       SELECT pg.patient_id FROM patient p JOIN patient_program pg ON p.patient_id=pg.patient_id   "
            + "                       WHERE pg.voided=0 AND p.voided=0 AND program_id IN ( ${1} , ${2} ) AND pg.date_enrolled <=  :endDate AND location_id= :location  "
            + "                        ) base_cohort ON base_cohort.patient_id = p.person_id   "
            + "                        JOIN (        "
            + "                   SELECT p.patient_id   "
            + "                      FROM  patient p     "
            + "                      INNER JOIN encounter e ON e.patient_id = p.patient_id     "
            + "                      INNER JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                      INNER JOIN (SELECT  p.patient_id, MIN(e.encounter_datetime) first_pickup_date    "
            + "                   FROM    patient p     "
            + "                   INNER JOIN encounter e ON e.patient_id = p.patient_id    "
            + "                   INNER JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                   WHERE   p.voided = 0     "
            + "                       AND e.voided = 0     "
            + "                       AND o.voided = 0     "
            + "                       AND e.location_id = :location    "
            + "                       AND e.encounter_type =  ${6}    "
            + "                       AND o.concept_id =  ${1719}    "
            + "                       AND o.value_coded IN (${23954})    "
            + "                       AND e.encounter_datetime >= :startDate   "
            + "                       AND e.encounter_datetime <= :endDate   "
            + "                   GROUP BY p.patient_id) AS pickup    "
            + "                   ON pickup.patient_id = p.patient_id   "
            + "                      WHERE p.patient_id NOT IN (  "
            + "                        SELECT patient_id     "
            + "                        FROM patient p    "
            + "                        WHERE p.voided = 0     "
            + "                            AND e.voided = 0     "
            + "                            AND o.voided = 0     "
            + "                            AND e.location_id = :location    "
            + "                            AND e.encounter_type =  ${6}    "
            + "                            AND o.concept_id =  ${1719}    "
            + "                            AND o.value_coded IN (${23954})    "
            + "                            AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)     "
            + "                            AND e.encounter_datetime < pickup.first_pickup_date "
            + "                        UNION "
            + "                        SELECT p.patient_id "
            + "                        FROM patient p "
            + "                            INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + "                            INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                        WHERE p.voided = 0 AND e.voided = 0 "
            + "                            AND o.voided = 0 "
            + "                            AND e.encounter_type=   ${60} "
            + "                            AND (o.concept_id= ${23985}  AND o.value_coded IN (${23954},${23984})) "
            + "                            AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)     "
            + "                            AND e.encounter_datetime < pickup.first_pickup_date)  "
            + "                   UNION  "
            + "                   SELECT p.patient_id   "
            + "                      FROM  patient p     "
            + "                      INNER JOIN encounter e ON e.patient_id = p.patient_id     "
            + "                      INNER JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                      INNER JOIN (SELECT  p.patient_id, MIN(e.encounter_datetime) first_pickup_date    "
            + "                   FROM    patient p     "
            + "                   INNER JOIN encounter e ON e.patient_id = p.patient_id    "
            + "                   INNER JOIN obs o ON o.encounter_id = e.encounter_id     "
            + "                   WHERE   p.voided = 0     "
            + "                       AND e.voided = 0     "
            + "                       AND o.voided = 0     "
            + "                       AND e.location_id = :location    "
            + "                       AND e.encounter_type =  ${60}    "
            + "                       AND o.concept_id =  ${23985}    "
            + "                       AND o.value_coded IN ( ${23954} , ${23984} )    "
            + "                       AND e.encounter_datetime >= :startDate   "
            + "                       AND e.encounter_datetime <= :endDate   "
            + "                   GROUP BY p.patient_id) AS pickup    "
            + "                   ON pickup.patient_id = p.patient_id   "
            + "                      WHERE p.patient_id NOT IN ( SELECT patient_id     "
            + "                    FROM patient p    "
            + "              WHERE p.voided = 0     "
            + "                         AND e.voided = 0     "
            + "                         AND o.voided = 0     "
            + "                         AND e.location_id = :location    "
            + "                         AND e.encounter_type =  ${6}    "
            + "                         AND o.concept_id =  ${23985}    "
            + "                         AND o.value_coded IN (${23954} , ${23984})    "
            + "                         AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)     "
            + "                         AND e.encounter_datetime < pickup.first_pickup_date "
            + "                         UNION "
            + "                        SELECT p.patient_id "
            + "                        FROM patient p "
            + "                            INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + "                            INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                        WHERE p.voided = 0 AND e.voided = 0 "
            + "                            AND o.voided = 0 "
            + "                            AND e.encounter_type=   ${60} "
            + "                            AND (o.concept_id= ${23985}  AND o.value_coded IN (${23954},${23984})) "
            + "                            AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 4 MONTH)     "
            + "                            AND e.encounter_datetime < pickup.first_pickup_date) "
            + "                       UNION "
            + "                        SELECT p.patient_id "
            + "                        FROM patient p "
            + "                            INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + "                            INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                            INNER JOIN obs o2 ON e.encounter_id = o2.encounter_id "
            + "                        WHERE p.voided = 0 AND e.voided = 0 "
            + "                            AND o.voided = 0 "
            + "                            AND e.encounter_type= ${60} "
            + "                            AND (o.concept_id= ${23985}  AND o.value_coded IN (${656} ,${23982})) "
            + "                            AND (o2.concept_id= ${23987}  AND o2.value_coded IN (${1256},${1705})) "
            + "                            AND e.encounter_datetime BETWEEN :startDate AND :endDate "
            + "                            GROUP BY p.patient_id "
            + "                       UNION   "
            + "                       SELECT p.patient_id FROM patient p    "
            + "                       JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                       JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                       WHERE e.encounter_type =  ${53}  AND o.concept_id =  ${6128}    "
            + "                       AND o.voided = 0 AND e.voided = 0    "
            + "                       AND p.voided = 0 AND e.location_id = :location   "
            + "                       AND o.value_datetime IS NOT NULL   "
            + "                       AND o.value_datetime BETWEEN :startDate AND :endDate   "
            + "                       UNION   "
            + "                       SELECT p.patient_id FROM patient p    "
            + "                       JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                       JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                       WHERE e.encounter_type =  ${6}  AND o.concept_id =  ${6122}    "
            + "                       AND o.voided = 0 AND e.voided = 0    "
            + "                       AND p.voided = 0 AND e.location_id = :location   "
            + "                       AND o.value_coded =  ${1256}    "
            + "                       AND e.encounter_datetime BETWEEN :startDate AND :endDate   "
            + "                       UNION   "
            + "                       SELECT p.patient_id FROM patient p    "
            + "                       JOIN encounter e ON e.patient_id = p.patient_id   "
            + "                       JOIN obs o ON o.encounter_id = e.encounter_id   "
            + "                       WHERE e.encounter_type IN ( ${6} , ${9} ) AND o.concept_id =  ${6128}    "
            + "                       AND o.voided = 0 AND e.voided = 0    "
            + "                       AND p.voided = 0 AND e.location_id = :location   "
            + "                       AND o.value_datetime IS NOT NULL   "
            + "                       AND o.value_datetime BETWEEN :startDate AND :endDate   "
            + "                       UNION  "
            + "                       SELECT p.patient_id "
            + "                        FROM  patient p "
            + "                                INNER JOIN encounter e ON e.patient_id = p.patient_id "
            + "                                INNER JOIN obs o ON o.encounter_id = e.encounter_id "
            + "                                INNER JOIN (SELECT  p.patient_id, MIN(e.encounter_datetime) first_pickup_date "
            + "                                            FROM patient p INNER JOIN encounter e ON e.patient_id = p.patient_id "
            + "                                                INNER JOIN obs o ON o.encounter_id = e.encounter_id "
            + "                                                INNER JOIN obs o2 on o2.encounter_id = e.encounter_id "
            + "                                            WHERE   p.voided = 0 "
            + "                                                AND e.voided = 0 "
            + "                                                AND o.voided = 0 "
            + "                                                AND e.location_id = :location "
            + "                                                AND e.encounter_type = ${60} "
            + "                                                AND (o.concept_id = ${23985} AND o.value_coded IN (${656},${23982})) "
            + "                                                AND ((o2.concept_id = ${23987} AND (o2.value_coded = ${1257} OR o2.value_coded IS NULL)) "
            + "                                                OR  o2.concept_id NOT IN( SELECT oo.concept_id FROM obs oo WHERE oo.voided = 0 "
            + "                                                                AND oo.encounter_id = e.encounter_id "
            + "                                                                AND oo.concept_id = ${23987} )) "
            + "                                                AND e.encounter_datetime BETWEEN DATE_SUB(:endDate, INTERVAL 210 DAY) AND :endDate "
            + "                                            GROUP BY p.patient_id) AS pickup "
            + "                                            ON pickup.patient_id = p.patient_id "
            + "                        WHERE p.patient_id NOT IN ( "
            + "                            SELECT pp.patient_id "
            + "                            FROM patient pp "
            + "                                    INNER JOIN encounter ee ON ee.patient_id = pp.patient_id "
            + "                                    INNER JOIN obs oo ON oo.encounter_id = ee.encounter_id "
            + "                            WHERE pp.voided = 0 "
            + "                            AND p.patient_id = pp.patient_id "
            + "                            AND ee.voided = 0 "
            + "                            AND oo.voided = 0 "
            + "                            AND ee.location_id = :location "
            + "                            AND ee.encounter_type = ${60} "
            + "                            AND oo.concept_id = ${23985} "
            + "                            AND oo.value_coded IN (${656}, ${23982}) "
            + "                            AND ee.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH) "
            + "                            AND ee.encounter_datetime < pickup.first_pickup_date "
            + "                            UNION "
            + "                            SELECT p.patient_id FROM patient p "
            + "                            JOIN encounter e ON e.patient_id = p.patient_id "
            + "                            JOIN obs o ON o.encounter_id = e.encounter_id "
            + "                            WHERE e.encounter_type =   ${53}   AND o.concept_id =   ${6128} "
            + "                            AND o.voided = 0 AND e.voided = 0 "
            + "                            AND p.voided = 0 AND e.location_id = :location "
            + "                            AND o.value_datetime IS NOT NULL "
            + "                            AND o.value_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH) "
            + "                            AND o.value_datetime < pickup.first_pickup_date "
            + "                            UNION "
            + "                            SELECT p.patient_id FROM patient p "
            + "                            JOIN encounter e ON e.patient_id = p.patient_id "
            + "                            JOIN obs o ON o.encounter_id = e.encounter_id "
            + "                            WHERE e.encounter_type =   ${6}   AND o.concept_id =   ${6122} "
            + "                            AND o.voided = 0 AND e.voided = 0 "
            + "                            AND p.voided = 0 AND e.location_id = :location "
            + "                            AND o.value_coded =   ${1256} "
            + "                            AND e.encounter_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH) "
            + "                            AND e.encounter_datetime < pickup.first_pickup_date "
            + "                            UNION "
            + "                            SELECT p.patient_id FROM patient p "
            + "                            JOIN encounter e ON e.patient_id = p.patient_id "
            + "                            JOIN obs o ON o.encounter_id = e.encounter_id "
            + "                            WHERE e.encounter_type IN (${6},${9}) AND o.concept_id = ${6128} "
            + "                            AND o.voided = 0 AND e.voided = 0 "
            + "                            AND p.voided = 0 AND e.location_id = :location "
            + "                            AND o.value_datetime IS NOT NULL "
            + "                            AND o.value_datetime >= DATE_SUB(pickup.first_pickup_date, INTERVAL 7 MONTH) "
            + "                            AND o.value_datetime < pickup.first_pickup_date) "
            + "                        GROUP BY p.patient_id "
            + "                        UNION "
            + "                        SELECT p.patient_id "
            + "                        FROM patient p "
            + "                            INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + "                            INNER JOIN obs o ON e.encounter_id = o.encounter_id "
            + "                            INNER JOIN obs o2 ON e.encounter_id = o2.encounter_id "
            + "                        WHERE p.voided = 0 AND e.voided = 0 "
            + "                            AND o.voided = 0 "
            + "                            AND e.encounter_type=  ${60} "
            + "                            AND (o.concept_id= ${23985}  AND o.value_coded IN (${656},${23982})) "
            + "                            AND (o2.concept_id= ${23987}  AND o2.value_coded IN (${1256},${1705})) "
            + "                            AND e.encounter_datetime BETWEEN :startDate AND :endDate "
            + "                            GROUP BY p.patient_id    "
            + "                        ) TPT ON TPT.patient_id = p.person_id WHERE p.voided=0 ";

    StringSubstitutor substitutor = new StringSubstitutor(valuesMap);
    return substitutor.replace(query);
  }
}
