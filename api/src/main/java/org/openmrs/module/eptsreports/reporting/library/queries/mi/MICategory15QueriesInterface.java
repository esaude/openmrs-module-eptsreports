package org.openmrs.module.eptsreports.reporting.library.queries.mi;

public interface MICategory15QueriesInterface {

  class QUERY {

    public static final String findPatientsWithClinicalConsultationDuringRevisionPeriod =
        "Select maxEnc.patient_id from ( "
            + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
            + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
            + "group by p.patient_id "
            + ")maxEnc";

    public static final String
        findPatientsWithClinicalConsultationDuringRevisionPeriodAndAgeGreaterOrEqualTwoYears =
            "Select maxEnc.patient_id from ( "
                + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "INNER JOIN person pe ON maxEnc.patient_id=pe.person_id "
                + "and (TIMESTAMPDIFF(year,pe.birthdate,maxEnc.encounter_datetime)) >=2 AND pe.birthdate IS NOT NULL and pe.voided = 0 ";

    public static final String findPatientsWhoArePregnantSpecificForCategory15MI =
        " SELECT p.patient_id FROM person pe "
            + " INNER JOIN patient p ON pe.person_id = p.patient_id "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs obsGravida ON e.encounter_id = obsGravida.encounter_id "
            + " WHERE pe.voided = 0 AND p.voided = 0 AND e.voided = 0 AND obsGravida.voided = 0 AND e.encounter_type = 6 AND e.location_id = :location "
            + " AND e.encounter_datetime between (:endRevisionDate - INTERVAL 11 MONTH + INTERVAL 1 DAY) and (:endRevisionDate - INTERVAL 2 MONTH) "
            + " AND obsGravida.concept_id = 1982 AND obsGravida.value_coded = 1065 AND pe.gender = 'F' "
            + " group by patient_id ";

    public static final String findPatientsWhoAreBreastfeedingSpecificForCategory15MI =
        " SELECT p.patient_id FROM person pe "
            + " INNER JOIN patient p ON pe.person_id = p.patient_id "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs obsLactante ON e.encounter_id = obsLactante.encounter_id "
            + " WHERE pe.voided = 0 AND p.voided = 0 AND e.voided = 0 AND obsLactante.voided = 0 AND e.encounter_type = 6 AND e.location_id = :location "
            + " AND e.encounter_datetime between (:endRevisionDate - INTERVAL 20 MONTH + INTERVAL 1 DAY) and (:endRevisionDate - INTERVAL 2 MONTH) "
            + " AND obsLactante.concept_id = 6332 AND obsLactante.value_coded = 1065 AND pe.gender = 'F' "
            + " group by patient_id ";

    public static final String
        findPatientsWithClinicalConsultationAndARTStartDateGreaterThanThreeMonths =
            " SELECT patient_id from ( "
                + " select art.patient_id, art.art_start_date from (SELECT patient_id, art_start_date FROM ( "
                + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
                + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
                + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
                + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
                + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
                + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endRevisionDate AND e.location_id = :location "
                + " GROUP BY p.patient_id "
                + " ) art_start "
                + " GROUP BY art_start.patient_id "
                + " ) tx_new "
                + ") art "
                + "inner join "
                + "(select patient_id, encounter_datetime from ( "
                + "select p.patient_id, max(e.encounter_datetime) encounter_datetime FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate "
                + "and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc "
                + ") consulta on consulta.patient_id = art.patient_id "
                + "INNER JOIN person pe ON art.patient_id=pe.person_id "
                + "and (TIMESTAMPDIFF(year,pe.birthdate,consulta.encounter_datetime)) >=2 AND pe.birthdate IS NOT NULL and pe.voided = 0 "
                + "where (TIMESTAMPDIFF(MONTH,art.art_start_date,consulta.encounter_datetime)) >3 "
                + ") final ";

    public static final String
        findPatientsWithClinicalConsultationAndARTStartDateGreaterThanTwentyOneMonths =
            " SELECT patient_id from ( "
                + " select art.patient_id, art.art_start_date from (SELECT patient_id, art_start_date FROM ( "
                + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
                + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
                + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
                + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
                + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
                + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endRevisionDate AND e.location_id = :location "
                + " GROUP BY p.patient_id "
                + " ) art_start "
                + " GROUP BY art_start.patient_id "
                + " ) tx_new "
                + ") art "
                + "inner join "
                + "(select patient_id, encounter_datetime from ( "
                + "select p.patient_id, max(e.encounter_datetime) encounter_datetime FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate "
                + "and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc ) consulta on consulta.patient_id = art.patient_id "
                + "where (TIMESTAMPDIFF(MONTH,art.art_start_date,consulta.encounter_datetime)) >21 "
                + ") final ";

    public static final String findPatientsWithClinicalConsultationOrARTPickUpInTheLastThreeMonths =
        "select enc.patient_id  from "
            + "( "
            + "select p.patient_id,  max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between :startInclusionDate and  :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ") a "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  <= :endRevisionDate "
            + "and e.location_id=:location "
            + "union "
            + "SELECT p.patient_id, value_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 AND o.concept_id=23866 and e.location_id=:location "
            + "and o.value_datetime <= :endRevisionDate "
            + ")enc  on a.patient_id = enc.patient_id "
            + "and enc.data  between date_sub(a.data, INTERVAL 30 DAY) and date_sub(a.data, INTERVAL 1 DAY) "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  <= :endRevisionDate "
            + "and e.location_id=:location "
            + "union "
            + "SELECT p.patient_id, value_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 AND o.concept_id=23866 and e.location_id=:location "
            + "and o.value_datetime <= :endRevisionDate "
            + ")enc2  on a.patient_id = enc2.patient_id "
            + "and enc2.data  between date_sub(a.data, INTERVAL 60 DAY) and date_sub(a.data, INTERVAL 31 DAY) "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  <= :endRevisionDate "
            + "and e.location_id=:location "
            + "union "
            + "SELECT p.patient_id, value_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 AND o.concept_id=23866 and e.location_id=:location "
            + "and o.value_datetime <= :endRevisionDate "
            + ")enc3  on a.patient_id = enc3.patient_id "
            + "and enc3.data  between date_sub(a.data, INTERVAL 90 DAY) and date_sub(a.data, INTERVAL 61 DAY) ";

    public static final String findPatientsWithTheLastCD4LessThan200OrEqualInClinicalConsultation =
        "select patient_id from (Select maxEnc.patient_id, cd4.obs_datetime, encounter_datetime from ( "
            + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
            + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
            + "group by p.patient_id "
            + ")maxEnc "
            + "inner join "
            + "(select distinct max_cd4.patient_id,o.value_numeric, o.obs_datetime from ( "
            + "Select p.patient_id,max(o.obs_datetime) max_data_cd4  From patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and concept_id = 1695 and  e.encounter_type = 6 and e.location_id=:location group by p.patient_id "
            + ")max_cd4 "
            + "inner join obs o on o.person_id=max_cd4.patient_id and max_cd4.max_data_cd4=o.obs_datetime and o.voided=0 and "
            + "o.concept_id =1695 and o.value_numeric<=200 and o.location_id=:location "
            + ")cd4 on cd4.patient_id = maxEnc.patient_id and cd4.obs_datetime < maxEnc.encounter_datetime "
            + ")final ";

    public static final String
        findPatientsWithTheLastCargaViralGreaterOrEqualThan1000InClinicalConsultation =
            " select patient_id from (select maxEnc.patient_id, ultimaCVAlta.data_carga, encounter_datetime from (Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "  inner join "
                + " ( Select p.patient_id, max(e.encounter_datetime) data_carga "
                + " from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where 	p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and e.location_id = :location and o.value_numeric >= 1000 "
                + " group by p.patient_id "
                + " ) ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_carga < maxEnc.encounter_datetime "
                + " )final ";

    public static final String
        findPatientsWithTheLastCargaViralGreaterOrEqualThan1000RegisteredInTheLastClinicalConsultation =
            " select patient_id from (select maxEnc.patient_id, ultimaCVAlta.data_carga, encounter_datetime from (Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "  inner join "
                + " ( Select p.patient_id, max(e.encounter_datetime) data_carga "
                + " from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where 	p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and e.location_id = :location and o.value_numeric >= 1000 "
                + " group by p.patient_id "
                + " ) ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_carga = maxEnc.encounter_datetime "
                + " )final ";

    public static final String
        findPatientsRegisteredInOneMDSForStablePatientsAndHadCVBetweenTwelveAndEigtheenMonthsAfterCVLessThan1000 =
            "select patient_id from (select patient_id, data_carga from (select maxEnc.patient_id, ultimaCVAlta.data_carga, encounter_datetime from (Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "  inner join "
                + " ( Select p.patient_id, max(e.encounter_datetime) data_carga "
                + " from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and ((o.concept_id = 856 and o.value_numeric < 1000) OR (o.concept_id = 1305 and o.value_coded is not null)) and e.location_id = :location "
                + " group by p.patient_id "
                + " ) ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_carga < (maxEnc.encounter_datetime - INTERVAL 18 MONTH) "
                + " )final "
                + " where patient_id in "
                + " (Select p.patient_id "
                + " from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and o.concept_id = 856 and o.value_numeric is not null "
                + " and e.location_id = :location "
                + " and e.encounter_datetime between (final.data_carga + INTERVAL 12 MONTH) and (final.data_carga + INTERVAL 18 MONTH) "
                + " group by p.patient_id)) final ";

    public static final String
        findAllPatientsWhoHaveLaboratoryInvestigationsRequestsAndViralChargeInLastConsultationDuringLastThreeMonths =
            "Select patient_id from ( "
                + "Select maxEnc.patient_id,maxEnc.encounter_datetime, obsCV.obs_datetime from ( "
                + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc "
                + "inner join encounter  e on e.patient_id=maxEnc.patient_id "
                + "inner join obs obsCV on obsCV.encounter_id=e.encounter_id "
                + "where obsCV.concept_id=23722 and obsCV.value_coded = 856 and obsCV.voided=0 and e.voided=0 "
                + " and e.encounter_type  = 6 and e.location_id = :location "
                + "and e.encounter_datetime >= (maxEnc.encounter_datetime - INTERVAL 3 MONTH) AND  e.encounter_datetime < maxEnc.encounter_datetime "
                + "group by maxEnc.patient_id "
                + ") final "
                + "group by final.patient_id ";

    // J
    public static final String findPatientsWhoAreActiveOnArtAndInAtleastOneDSD =
        "select maxEnc.patient_id from ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between :startInclusionDate and  :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + " )maxEnc "
            + "inner join( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23724) and  o.value_coded in (1256,1257)  and e.encounter_datetime<:endRevisionDate "
            + "group by p.patient_id "
            + "union "
            + "( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23730) and  o.value_coded in (1256,1257)  and e.encounter_datetime<:endRevisionDate "
            + "group by p.patient_id "
            + ") "
            + "union "
            + "( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23888) and  o.value_coded in (1256,1257)  and e.encounter_datetime<:endRevisionDate "
            + "group by p.patient_id "
            + ") "
            + "union "
            + "( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23729) and  o.value_coded in (1256,1257)  and e.encounter_datetime<:endRevisionDate "
            + "group by p.patient_id "
            + ") "
            + "union "
            + "( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23731) and  o.value_coded in (1256,1257)  and e.encounter_datetime<:endRevisionDate "
            + "group by p.patient_id "
            + ") "
            + ") mds on mds.patient_id = maxEnc.patient_id and mds.data< maxEnc.data ";

    // K
    public static final String findPatientsWhoHasRegisteredAsIniciarInAtLeastOneMDS =
        "select patient_id from ( "
            + "select maxEnc.patient_id, obsGaac.obs_datetime as data_Observacao, maxEnc.data as maxima_consulta, dataMaximoModelo.data as maximo_modelo from "
            + "( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between :startInclusionDate and  :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + " "
            + " )maxEnc "
            + "inner join "
            + "( "
            + "select p.patient_id, e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23724,23730,23888,23729,23731) and o.value_coded=1256 and e.encounter_datetime<:endRevisionDate "
            + " "
            + ")dataMaximoModelo on dataMaximoModelo.patient_id=maxEnc.patient_id "
            + " "
            + "inner join obs obsGaac on obsGaac.person_id=maxEnc.patient_id  and obsGaac.concept_id in(23724,23730,23888,23729,23731)  and obsGaac.value_coded = 1256  and dataMaximoModelo.data=maxEnc.data and "
            + " "
            + " "
            + "dataMaximoModelo.data=obsGaac.obs_datetime "
            + "group by maxEnc.patient_id "
            + ") final ";

    // L
    public static final String findPatientsWhoHasRegisteredAsFimInAtLeastOneMDS =
        "select patient_id from ( "
            + " "
            + "select maxEnc.patient_id, obsGaac.obs_datetime as data_Observacao, maxEnc.data as maxima_consulta, dataMaximoModelo.data as maximo_modelo from "
            + "( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between :startInclusionDate and  :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + " "
            + " )maxEnc "
            + "inner join "
            + "( "
            + "select p.patient_id, e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and o.concept_id in(23724,23730,23888,23729,23731) and o.value_coded=1267 and e.encounter_datetime<:endRevisionDate "
            + " "
            + ")dataMaximoModelo on dataMaximoModelo.patient_id=maxEnc.patient_id "
            + " "
            + "inner join obs obsGaac on obsGaac.person_id=maxEnc.patient_id  and obsGaac.concept_id in(23724,23730,23888,23729,23731)  and obsGaac.value_coded = 1267  and dataMaximoModelo.data=maxEnc.data and "
            + " "
            + " "
            + "dataMaximoModelo.data=obsGaac.obs_datetime "
            + "group by maxEnc.patient_id "
            + ") final ";
  }
}
