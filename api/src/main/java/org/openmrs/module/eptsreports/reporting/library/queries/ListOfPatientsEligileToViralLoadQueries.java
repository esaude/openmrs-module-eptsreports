package org.openmrs.module.eptsreports.reporting.library.queries;

public interface ListOfPatientsEligileToViralLoadQueries {

  class QUERY {

    public static final String findPatientsEligibleToViralLoadList =
        "select 	marcadoVisita.patient_id, "
            + "		pid.identifier as NID, "
            + "		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) NomeCompleto, "
            + "		per.birthdate, "
            + "		round(datediff(:endDate,per.birthdate)/365) idade_actual, "
            + "		per.gender, "
            + "		marcadoVisita.data_inicio, "
            + "		regime.ultimo_regime regime_tarv, "
            + "		linha.valorLinha linha_terapeutica, "
            + "		pat.value contacto, "
            + "		ultimaCarga.data_carga, "
            + "		ultimaCarga.valor_carga, "
            + "		consulta.data_consulta data_ultima_consulta, "
            + "		consulta.proxima_consulta data_proxima_consulta, "
            + "		levantamento.data_levantamento_fila data_ultimo_fila, "
            + "		levantamento.proximo_levantamento_fila data_proximo_fila, "
            + "		levantamentoRecepcao.data_levantamento_recepcao data_recepcao_levantou, "
            + "		levantamentoRecepcao.proximo_levantamento_recepcao data_recepcao_levantou30, "
            + "		sessoesApss.nrapss sessoes "
            + "from "
            + "( "
            + "	select 	consultaLevantamento.patient_id, "
            + "			consultaLevantamento.data_consulta, "
            + "			consultaLevantamento.data_proxima_consulta, "
            + "			inicio_real.data_inicio "
            + "	from "
            + "( "
            + "		select patient_id,max(data_consulta) data_consulta,max(data_proxima_consulta) data_proxima_consulta "
            + "		from "
            + "		( "
            + "			Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime data_consulta ,o.value_datetime data_proxima_consulta "
            + "			from "
            + "				(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "					from 	encounter e "
            + "							inner join patient p on p.patient_id=e.patient_id "
            + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "					group by p.patient_id "
            + "				) ultimavisita "
            + "				inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "				inner join obs o on o.encounter_id=e.encounter_id "
            + "			where 	o.concept_id=5096 and o.voided=0 and e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "					e.encounter_type=18 and e.location_id=:location and o.value_datetime between :startDate and :endDate "
            + "			union "
            + "			Select 	p.patient_id,max(value_datetime) data_consulta,(max(value_datetime) + INTERVAL 30 day) data_proxima_consulta "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "					o.concept_id=23866 and o.value_datetime is not null and "
            + "					o.value_datetime<= :startDate and e.location_id=:location and (o.value_datetime + interval 30 day) between  :startDate and :endDate "
            + "			group by p.patient_id "
            + "			union "
            + "			Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime,o.value_datetime "
            + "			from "
            + "				(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "					from 	encounter e "
            + "							inner join patient p on p.patient_id=e.patient_id "
            + "					where 	e.voided=0 and p.voided=0 and e.encounter_type in (6,9) and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "					group by p.patient_id "
            + "				) ultimavisita "
            + "				inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "				left join obs o on o.encounter_id=e.encounter_id and o.concept_id=1410 and o.voided=0 "
            + "			where  	e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "					e.encounter_type in (6,9) and e.location_id=:location and o.value_datetime between :startDate and :endDate "
            + "			group by ultimavisita.patient_id "
            + "		) consultaRecepcao "
            + "		group by patient_id "
            + "	) consultaLevantamento "
            + "	inner join "
            + "	( "
            + "		select patient_id,max(encounter_datetime) ultimoLevConsulta "
            + "		from "
            + "		( "
            + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_type in (18,6,9) and "
            + "					e.location_id=:location and e.encounter_datetime<=:startDate "
            + "			group by p.patient_id "
            + "			union "
            + "			Select 	p.patient_id,max(value_datetime) encounter_datetime "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "					o.concept_id=23866 and o.value_datetime is not null and "
            + "					o.value_datetime<=:startDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		) allEncounter "
            + "		group by patient_id "
            + "	)maxConsultaLeva on maxConsultaLeva.patient_id=consultaLevantamento.patient_id "
            + "	inner join "
            + "	(	Select patient_id,min(data_inicio) data_inicio "
            + "		from "
            + "			( "
            + "				/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/ "
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and "
            + "						e.encounter_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				/*Patients on ART who have art start date: ART Start date*/ "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and "
            + "						o.concept_id=1190 and o.value_datetime is not null and "
            + "						o.value_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio "
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:startDate and location_id=:location "
            + "				group by pg.patient_id "
            + "				union "
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio "
            + "				  FROM 		patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:startDate and e.location_id=:location "
            + "				  GROUP BY 	p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "						o.concept_id=23866 and o.value_datetime is not null and "
            + "						o.value_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "			) inicio "
            + "		group by patient_id "
            + "	) inicio_real on consultaLevantamento.patient_id=inicio_real.patient_id "
            + "	left join "
            + "	( "
            + "			select maxCarga.patient_id,maxCarga.data_carga,o.concept_id,o.value_numeric "
            + "		from "
            + "		( "
            + "			Select 	p.patient_id,max(o.obs_datetime) data_carga "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and "
            + "					o.concept_id in (1305,856) and o.obs_datetime <=:endDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		)maxCarga "
            + "		inner join encounter e on maxCarga.patient_id=e.patient_id "
            + "		inner join obs o on o.encounter_id=e.encounter_id "
            + "		where 	o.obs_datetime=maxCarga.data_carga and "
            + "				o.concept_id in (1305,856) and e.encounter_type in (13,6,9,53,51) and e.location_id=:location and "
            + "				e.voided=0 and o.voided=0 "
            + "	) carga_viral on consultaLevantamento.patient_id=carga_viral.patient_id and "
            + "		( "
            + "			(carga_viral.concept_id=1305 and carga_viral.data_carga between date_add(consultaLevantamento.data_proxima_consulta, interval -12 MONTH) and consultaLevantamento.data_proxima_consulta) or "
            + "			(carga_viral.concept_id=856 and carga_viral.value_numeric<1000  and carga_viral.data_carga between date_add(consultaLevantamento.data_proxima_consulta, interval -12 MONTH) and consultaLevantamento.data_proxima_consulta) or "
            + "			(carga_viral.concept_id=856 and carga_viral.value_numeric>=1000  and carga_viral.data_carga between date_add(consultaLevantamento.data_proxima_consulta, interval -3 MONTH) and consultaLevantamento.data_proxima_consulta) "
            + "		) "
            + "	left join "
            + "	( "
            + "		select patient_id,min(data_gravida) dataGravidaLactante "
            + "		from "
            + "		( "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1982 and value_coded=1065 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime  between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			/*Patients that are female and have “Number of weeks Pregnant” registered in the initial or follow-up consultation between start and end date*/ "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1279 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1600 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6331 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			select 	pp.patient_id,pp.date_enrolled data_gravida "
            + "			from 	patient_program pp "
            + "			where 	pp.program_id=8 and pp.voided=0 and "
            + "					pp.date_enrolled between date_add(:endDate, interval -9 month) AND :endDate and pp.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,obsART.value_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "					inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1982 and o.value_coded=1065 and "
            + "					e.encounter_type=53 and obsART.value_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location and "
            + "					obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select 	p.patient_id,o.value_datetime data_gravida "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1465 and "
            + "					e.encounter_type=6 and o.value_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,o.value_datetime data_parto "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=5599 and "
            + "					e.encounter_type in (5,6) and o.value_datetime between date_add(:endDate, interval -18 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id, e.encounter_datetime data_parto "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6332 and value_coded=1065 and "
            + "					e.encounter_type=6 and e.encounter_datetime between date_add(:endDate, interval -18 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id, obsART.value_datetime data_parto "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "					inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=6332 and o.value_coded=1065 and "
            + "					e.encounter_type=53 and e.location_id=:location and "
            + "					obsART.value_datetime between date_add(:endDate, interval -18 month) AND :endDate and "
            + "					obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select 	p.patient_id, e.encounter_datetime data_parto "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6332 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -18 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			select 	pg.patient_id,ps.start_date data_parto "
            + "			from 	patient p "
            + "					inner join patient_program pg on p.patient_id=pg.patient_id "
            + "					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and "
            + "					pg.program_id=8 and ps.state=27 and ps.end_date is null and "
            + "					ps.start_date between date_add(:endDate, interval -18 month) AND :endDate and location_id=:location "
            + "		) lactante_real "
            + "		inner join person pe on pe.person_id=lactante_real.patient_id and pe.voided=0 and pe.gender='F' "
            + "		group by lactante_real.patient_id "
            + "	) gravida on consultaLevantamento.patient_id=gravida.patient_id "
            + "	left join "
            + "	( "
            + "		select patient_id,max(data_estado) data_estado "
            + "		from "
            + "			( "
            + "				select 	pg.patient_id, "
            + "						max(ps.start_date) data_estado "
            + "				from 	patient p "
            + "						inner join patient_program pg on p.patient_id=pg.patient_id "
            + "						inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "				where 	pg.voided=0 and ps.voided=0 and p.voided=0 and "
            + "						pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and "
            + "						ps.start_date<=:startDate and location_id=:location "
            + "				group by pg.patient_id "
            + "				union "
            + "				select 	p.patient_id, "
            + "						max(o.obs_datetime) data_estado "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs  o on e.encounter_id=o.encounter_id "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and "
            + "						o.obs_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				select person_id as patient_id,death_date as data_estado "
            + "				from person "
            + "				where dead=1 and death_date is not null and death_date<=:startDate "
            + "				union "
            + "				select 	p.patient_id, "
            + "						max(obsObito.obs_datetime) data_estado "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs obsObito on e.encounter_id=obsObito.encounter_id "
            + "				where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and "
            + "						e.encounter_type in (21,36,37) and  e.encounter_datetime<=:startDate and  e.location_id=:location and "
            + "						obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 "
            + "				group by p.patient_id "
            + "			) allSaida "
            + "		group by patient_id "
            + "	) saida on consultaLevantamento.patient_id=saida.patient_id "
            + "	where 	consultaLevantamento.data_proxima_consulta between :startDate and :endDate and "
            + "			gravida.patient_id is null and "
            + "			carga_viral.patient_id is null and "
            + "			(saida.patient_id is null or (saida.patient_id is not null and maxConsultaLeva.ultimoLevConsulta>saida.data_estado)) and "
            + "			timestampdiff(month,inicio_real.data_inicio,:endDate)>= 6 "
            + ") marcadoVisita "
            + "left join "
            + "( "
            + "	Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime data_consulta,min(o.value_datetime) proxima_consulta "
            + "	from "
            + "		(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "			from 	encounter e "
            + "					inner join patient p on p.patient_id=e.patient_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_type in (6,9) and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "			group by p.patient_id "
            + "		) ultimavisita "
            + "		inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "		left join obs o on o.encounter_id=e.encounter_id and o.concept_id=1410 and o.voided=0 "
            + "	where  	e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "			e.encounter_type in (6,9) and e.location_id=:location "
            + "	group by ultimavisita.patient_id "
            + ") consulta on marcadoVisita.patient_id=consulta.patient_id "
            + "left join "
            + "( "
            + "	Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime data_levantamento_fila ,min(o.value_datetime) proximo_levantamento_fila "
            + "	from "
            + "		(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "			from 	encounter e "
            + "					inner join patient p on p.patient_id=e.patient_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "			group by p.patient_id "
            + "		) ultimavisita "
            + "		inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "		inner join obs o on o.encounter_id=e.encounter_id "
            + "	where 	o.concept_id=5096 and o.voided=0 and e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "			e.encounter_type=18 and e.location_id=:location "
            + "	group by ultimavisita.patient_id "
            + ")levantamento on marcadoVisita.patient_id=levantamento.patient_id "
            + "left join "
            + "( "
            + "	Select 	p.patient_id,max(value_datetime) data_levantamento_recepcao,(max(value_datetime) + INTERVAL 30 day) proximo_levantamento_recepcao "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime<=:startDate and e.location_id=:location "
            + "	group by p.patient_id "
            + ") levantamentoRecepcao on marcadoVisita.patient_id=levantamentoRecepcao.patient_id "
            + "left join "
            + "( "
            + "	select maxCargaViral.patient_id,maxCargaViral.data_carga,if(o.concept_id=856,if(o.value_numeric<=0,'Indetectavel',o.value_numeric),'Indetectavel') valor_carga "
            + "	from "
            + "	( "
            + "		Select 	p.patient_id,max(o.obs_datetime) data_carga "
            + "		from 	patient p "
            + "				inner join encounter e on p.patient_id=e.patient_id "
            + "				inner join obs o on e.encounter_id=o.encounter_id "
            + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and "
            + "				o.concept_id in (856,1305) and "
            + "				o.obs_datetime<=:startDate and e.location_id=:location "
            + "		group by p.patient_id "
            + "	) maxCargaViral "
            + "	inner join obs o on maxCargaViral.patient_id=o.person_id and maxCargaViral.data_carga=o.obs_datetime and o.voided=0 and o.concept_id in (856,1305) and o.location_id=:location "
            + ") ultimaCarga on marcadoVisita.patient_id=ultimaCarga.patient_id "
            + "left join "
            + "( "
            + "	select altacv.patient_id, count(distinct e.encounter_id) nrapss "
            + "	from "
            + "	( "
            + "		select maxCargaViral.patient_id,maxCargaViral.data_carga,o.value_numeric valor_carga "
            + "		from "
            + "		( "
            + "			Select 	p.patient_id,max(o.obs_datetime) data_carga "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and "
            + "					o.concept_id in (856,1305) and "
            + "					o.obs_datetime<=:startDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		) maxCargaViral "
            + "		inner join obs o on maxCargaViral.patient_id=o.person_id and maxCargaViral.data_carga=o.obs_datetime and o.voided=0 and "
            + "					o.concept_id=856 and o.value_numeric>=1000 and o.location_id=:location "
            + "	) altacv "
            + "	inner join encounter e on altacv.patient_id=e.patient_id "
            + "	where e.voided=0 and e.encounter_datetime between altacv.data_carga and :startDate "
            + "			and e.encounter_type=35 and e.location_id=:location "
            + "	group by altacv.patient_id "
            + ") sessoesApss on marcadoVisita.patient_id=sessoesApss.patient_id "
            + "left join "
            + "( "
            + "	select maxLinha.patient_id,maxLinha.data_linha,if(o.value_coded=21150,'1ª Linha',if(o.value_coded=21148,'2ª Linha','3ª Linha')) valorLinha "
            + "	from "
            + "	( "
            + "		Select 	p.patient_id,max(o.obs_datetime) data_linha "
            + "		from 	patient p "
            + "				inner join encounter e on p.patient_id=e.patient_id "
            + "				inner join obs o on e.encounter_id=o.encounter_id "
            + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9) and "
            + "				o.concept_id=21151 and o.obs_datetime<=:startDate and e.location_id=:location "
            + "		group by p.patient_id "
            + "	) maxLinha "
            + "	inner join obs o on maxLinha.patient_id=o.person_id and maxLinha.data_linha=o.obs_datetime and o.voided=0 and o.concept_id=21151 and o.location_id=:location "
            + ") linha on marcadoVisita.patient_id=linha.patient_id "
            + "left join "
            + "( "
            + "	select 	ultimo_lev.patient_id, "
            + "			case o.value_coded "
            + "			when 1703 then 'AZT+3TC+EFV' "
            + "			when 6100 then 'AZT+3TC+LPV/r' "
            + "			when 1651 then 'AZT+3TC+NVP' "
            + "			when 6324 then 'TDF+3TC+EFV' "
            + "			when 6104 then 'ABC+3TC+EFV' "
            + "			when 23784 then 'TDF+3TC+DTG' "
            + "			when 23786 then 'ABC+3TC+DTG' "
            + "			when 23785 then 'TDF+3TC+DTG' "
            + "			when 6116 then 'AZT+3TC+ABC' "
            + "			when 6106 then 'ABC+3TC+LPV/r' "
            + "			when 6105 then 'ABC+3TC+NVP' "
            + "			when 6108 then 'TDF+3TC+LPV/r' "
            + "			when 23790 then 'TDF+3TC+LPV/r+RTV' "
            + "			when 23791 then 'TDF+3TC+ATV/r' "
            + "			when 23792 then 'ABC+3TC+ATV/r' "
            + "			when 23793 then 'AZT+3TC+ATV/r' "
            + "			when 23795 then 'ABC+3TC+ATV/r+RAL' "
            + "			when 23796 then 'TDF+3TC+ATV/r+RAL' "
            + "			when 23801 then 'AZT+3TC+RAL' "
            + "			when 23802 then 'AZT+3TC+DRV/r' "
            + "			when 23815 then 'AZT+3TC+DTG' "
            + "			when 6329 then 'TDF+3TC+RAL+DRV/r' "
            + "			when 23797 then 'ABC+3TC+DRV/r+RAL' "
            + "			when 23798 then '3TC+RAL+DRV/r' "
            + "			when 23803 then 'AZT+3TC+RAL+DRV/r' "
            + "			when 6243 then 'TDF+3TC+NVP' "
            + "			when 6103 then 'D4T+3TC+LPV/r' "
            + "			when 792 then 'D4T+3TC+NVP' "
            + "			when 1827 then 'D4T+3TC+EFV' "
            + "			when 6102 then 'D4T+3TC+ABC' "
            + "			when 1311 then 'ABC+3TC+LPV/r' "
            + "			when 1312 then 'ABC+3TC+NVP' "
            + "			when 1313 then 'ABC+3TC+EFV' "
            + "			when 1314 then 'AZT+3TC+LPV/r' "
            + "			when 1315 then 'TDF+3TC+EFV' "
            + "			when 6330 then 'AZT+3TC+RAL+DRV/r' "
            + "			when 6325 then 'D4T+3TC+ABC+LPV/r' "
            + "			when 6326 then 'AZT+3TC+ABC+LPV/r' "
            + "			when 6327 then 'D4T+3TC+ABC+EFV' "
            + "			when 6328 then 'AZT+3TC+ABC+EFV' "
            + "			when 6109 then 'AZT+DDI+LPV/r' "
            + "			when 21163 then 'AZT+3TC+LPV/r' "
            + "			when 23799 then 'TDF+3TC+DTG' "
            + "			when 23800 then 'ABC+3TC+DTG' "
            + "			when 6110 then 'D4T20+3TC+NVP' "
            + "			when 1702 then 'AZT+3TC+NFV' "
            + "			when 817  then 'AZT+3TC+ABC' "
            + "			when 6244 then 'AZT+3TC+RTV' "
            + "			when 1700 then 'AZT+DDl+NFV' "
            + "			when 633  then 'EFV' "
            + "			when 625  then 'D4T' "
            + "			when 631  then 'NVP' "
            + "			when 628  then '3TC' "
            + "			when 635  then 'NFV' "
            + "			when 797  then 'AZT' "
            + "			when 814  then 'ABC' "
            + "			when 6107 then 'TDF+AZT+3TC+LPV/r' "
            + "			when 6236 then 'D4T+DDI+RTV-IP' "
            + "			when 1701 then 'ABC+DDI+NFV' "
            + "			when 6114 then '3DFC' "
            + "			when 6115 then '2DFC+EFV' "
            + "			when 6233 then 'AZT+3TC+DDI+LPV' "
            + "			when 6234 then 'ABC+TDF+LPV' "
            + "			when 6242 then 'D4T+DDI+NVP' "
            + "			when 6118 then 'DDI50+ABC+LPV' "
            + "			else 'OUTRO' end as ultimo_regime, "
            + "			ultimo_lev.encounter_datetime data_regime "
            + "	from 	obs o, "
            + "			(	select p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "				where 	encounter_type=18 and e.voided=0 and "
            + "						encounter_datetime <=:startDate and e.location_id=:location and p.voided=0 "
            + "				group by patient_id "
            + "			) ultimo_lev "
            + "	where 	o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and "
            + "			o.concept_id=1088 and o.location_id=:location "
            + ") regime on marcadoVisita.patient_id=regime.patient_id "
            + "left join person_attribute pat on pat.person_id=marcadoVisita.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value <> '' and pat.voided=0 "
            + "left join "
            + "(	select pid1.* "
            + "	from patient_identifier pid1 "
            + "	inner join "
            + "		( "
            + "			select patient_id,min(patient_identifier_id) id "
            + "			from patient_identifier "
            + "			where voided=0 "
            + "			group by patient_id "
            + "		) pid2 "
            + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id "
            + ") pid on pid.patient_id=marcadoVisita.patient_id "
            + "left join "
            + "(	select pn1.* "
            + "	from person_name pn1 "
            + "	inner join "
            + "		( "
            + "			select person_id,min(person_name_id) id "
            + "			from person_name "
            + "			where voided=0 "
            + "			group by person_id "
            + "		) pn2 "
            + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id "
            + ") pn on pn.person_id=marcadoVisita.patient_id "
            + "inner join person per on per.person_id=marcadoVisita.patient_id "
            + "where marcadoVisita.data_proxima_consulta between :startDate and :endDate "
            + "group by marcadoVisita.patient_id ";

    public static final String findPatientsEligibleToViralLoad =
        "select 	marcadoVisita.patient_id "
            + "from "
            + "( "
            + "	select 	consultaLevantamento.patient_id, "
            + "			consultaLevantamento.data_consulta, "
            + "			consultaLevantamento.data_proxima_consulta, "
            + "			inicio_real.data_inicio "
            + "	from "
            + "( "
            + "		select patient_id,max(data_consulta) data_consulta,max(data_proxima_consulta) data_proxima_consulta "
            + "		from "
            + "		( "
            + "			Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime data_consulta ,o.value_datetime data_proxima_consulta "
            + "			from "
            + "				(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "					from 	encounter e "
            + "							inner join patient p on p.patient_id=e.patient_id "
            + "					where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "					group by p.patient_id "
            + "				) ultimavisita "
            + "				inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "				inner join obs o on o.encounter_id=e.encounter_id "
            + "			where 	o.concept_id=5096 and o.voided=0 and e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "					e.encounter_type=18 and e.location_id=:location and o.value_datetime between :startDate and :endDate "
            + "			union "
            + "			Select 	p.patient_id,max(value_datetime) data_consulta,(max(value_datetime) + INTERVAL 30 day) data_proxima_consulta "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "					o.concept_id=23866 and o.value_datetime is not null and "
            + "					o.value_datetime<= :startDate and e.location_id=:location and (o.value_datetime + interval 30 day) between  :startDate and :endDate "
            + "			group by p.patient_id "
            + "			union "
            + "			Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime,o.value_datetime "
            + "			from "
            + "				(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "					from 	encounter e "
            + "							inner join patient p on p.patient_id=e.patient_id "
            + "					where 	e.voided=0 and p.voided=0 and e.encounter_type in (6,9) and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "					group by p.patient_id "
            + "				) ultimavisita "
            + "				inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "				left join obs o on o.encounter_id=e.encounter_id and o.concept_id=1410 and o.voided=0 "
            + "			where  	e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "					e.encounter_type in (6,9) and e.location_id=:location and o.value_datetime between :startDate and :endDate "
            + "			group by ultimavisita.patient_id "
            + "		) consultaRecepcao "
            + "		group by patient_id "
            + "	) consultaLevantamento "
            + "	inner join "
            + "	( "
            + "		select patient_id,max(encounter_datetime) ultimoLevConsulta "
            + "		from "
            + "		( "
            + "			select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_type in (18,6,9) and "
            + "					e.location_id=:location and e.encounter_datetime<=:startDate "
            + "			group by p.patient_id "
            + "			union "
            + "			Select 	p.patient_id,max(value_datetime) encounter_datetime "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "					o.concept_id=23866 and o.value_datetime is not null and "
            + "					o.value_datetime<=:startDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		) allEncounter "
            + "		group by patient_id "
            + "	)maxConsultaLeva on maxConsultaLeva.patient_id=consultaLevantamento.patient_id "
            + "	inner join "
            + "	(	Select patient_id,min(data_inicio) data_inicio "
            + "		from "
            + "			( "
            + "				/*Patients on ART who initiated the ARV DRUGS: ART Regimen Start Date*/ "
            + "				Select 	p.patient_id,min(e.encounter_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on o.encounter_id=e.encounter_id "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (18,6,9) and o.concept_id=1255 and o.value_coded=1256 and "
            + "						e.encounter_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				/*Patients on ART who have art start date: ART Start date*/ "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (18,6,9,53) and "
            + "						o.concept_id=1190 and o.value_datetime is not null and "
            + "						o.value_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				select 	pg.patient_id,min(date_enrolled) data_inicio "
            + "				from 	patient p inner join patient_program pg on p.patient_id=pg.patient_id "
            + "				where 	pg.voided=0 and p.voided=0 and program_id=2 and date_enrolled<=:startDate and location_id=:location "
            + "				group by pg.patient_id "
            + "				union "
            + "				  SELECT 	e.patient_id, MIN(e.encounter_datetime) AS data_inicio "
            + "				  FROM 		patient p "
            + "							inner join encounter e on p.patient_id=e.patient_id "
            + "				  WHERE		p.voided=0 and e.encounter_type=18 AND e.voided=0 and e.encounter_datetime<=:startDate and e.location_id=:location "
            + "				  GROUP BY 	p.patient_id "
            + "				union "
            + "				Select 	p.patient_id,min(value_datetime) data_inicio "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs o on e.encounter_id=o.encounter_id "
            + "				where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "						o.concept_id=23866 and o.value_datetime is not null and "
            + "						o.value_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "			) inicio "
            + "		group by patient_id "
            + "	) inicio_real on consultaLevantamento.patient_id=inicio_real.patient_id "
            + "	left join "
            + "	( "
            + "			select maxCarga.patient_id,maxCarga.data_carga,o.concept_id,o.value_numeric "
            + "		from "
            + "		( "
            + "			Select 	p.patient_id,max(o.obs_datetime) data_carga "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and "
            + "					o.concept_id in (1305,856) and o.obs_datetime <=:endDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		)maxCarga "
            + "		inner join encounter e on maxCarga.patient_id=e.patient_id "
            + "		inner join obs o on o.encounter_id=e.encounter_id "
            + "		where 	o.obs_datetime=maxCarga.data_carga and "
            + "				o.concept_id in (1305,856) and e.encounter_type in (13,6,9,53,51) and e.location_id=:location and "
            + "				e.voided=0 and o.voided=0 "
            + "	) carga_viral on consultaLevantamento.patient_id=carga_viral.patient_id and "
            + "		( "
            + "			(carga_viral.concept_id=1305 and carga_viral.data_carga between date_add(consultaLevantamento.data_proxima_consulta, interval -12 MONTH) and consultaLevantamento.data_proxima_consulta) or "
            + "			(carga_viral.concept_id=856 and carga_viral.value_numeric<1000  and carga_viral.data_carga between date_add(consultaLevantamento.data_proxima_consulta, interval -12 MONTH) and consultaLevantamento.data_proxima_consulta) or "
            + "			(carga_viral.concept_id=856 and carga_viral.value_numeric>=1000  and carga_viral.data_carga between date_add(consultaLevantamento.data_proxima_consulta, interval -3 MONTH) and consultaLevantamento.data_proxima_consulta) "
            + "		) "
            + "	left join "
            + "	( "
            + "		select patient_id,min(data_gravida) dataGravidaLactante "
            + "		from "
            + "		( "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1982 and value_coded=1065 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime  between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			/*Patients that are female and have “Number of weeks Pregnant” registered in the initial or follow-up consultation between start and end date*/ "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1279 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=1600 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,e.encounter_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6331 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			select 	pp.patient_id,pp.date_enrolled data_gravida "
            + "			from 	patient_program pp "
            + "			where 	pp.program_id=8 and pp.voided=0 and "
            + "					pp.date_enrolled between date_add(:endDate, interval -9 month) AND :endDate and pp.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,obsART.value_datetime data_gravida "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "					inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1982 and o.value_coded=1065 and "
            + "					e.encounter_type=53 and obsART.value_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location and "
            + "					obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select 	p.patient_id,o.value_datetime data_gravida "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=1465 and "
            + "					e.encounter_type=6 and o.value_datetime between date_add(:endDate, interval -9 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id,o.value_datetime data_parto "
            + "			from 	patient p inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=5599 and "
            + "					e.encounter_type in (5,6) and o.value_datetime between date_add(:endDate, interval -18 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id, e.encounter_datetime data_parto "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6332 and value_coded=1065 and "
            + "					e.encounter_type=6 and e.encounter_datetime between date_add(:endDate, interval -18 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			Select 	p.patient_id, obsART.value_datetime data_parto "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "					inner join obs obsART on e.encounter_id=obsART.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and o.concept_id=6332 and o.value_coded=1065 and "
            + "					e.encounter_type=53 and e.location_id=:location and "
            + "					obsART.value_datetime between date_add(:endDate, interval -18 month) AND :endDate and "
            + "					obsART.concept_id=1190 and obsART.voided=0 "
            + "			union "
            + "			Select 	p.patient_id, e.encounter_datetime data_parto "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and concept_id=6334 and value_coded=6332 and "
            + "					e.encounter_type in (5,6) and e.encounter_datetime between date_add(:endDate, interval -18 month) AND :endDate and e.location_id=:location "
            + "			union "
            + "			select 	pg.patient_id,ps.start_date data_parto "
            + "			from 	patient p "
            + "					inner join patient_program pg on p.patient_id=pg.patient_id "
            + "					inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "			where 	pg.voided=0 and ps.voided=0 and p.voided=0 and "
            + "					pg.program_id=8 and ps.state=27 and ps.end_date is null and "
            + "					ps.start_date between date_add(:endDate, interval -18 month) AND :endDate and location_id=:location "
            + "		) lactante_real "
            + "		inner join person pe on pe.person_id=lactante_real.patient_id and pe.voided=0 and pe.gender='F' "
            + "		group by lactante_real.patient_id "
            + "	) gravida on consultaLevantamento.patient_id=gravida.patient_id "
            + "	left join "
            + "	( "
            + "		select patient_id,max(data_estado) data_estado "
            + "		from "
            + "			( "
            + "				select 	pg.patient_id, "
            + "						max(ps.start_date) data_estado "
            + "				from 	patient p "
            + "						inner join patient_program pg on p.patient_id=pg.patient_id "
            + "						inner join patient_state ps on pg.patient_program_id=ps.patient_program_id "
            + "				where 	pg.voided=0 and ps.voided=0 and p.voided=0 and "
            + "						pg.program_id=2 and ps.state in (7,8,10) and ps.end_date is null and "
            + "						ps.start_date<=:startDate and location_id=:location "
            + "				group by pg.patient_id "
            + "				union "
            + "				select 	p.patient_id, "
            + "						max(o.obs_datetime) data_estado "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs  o on e.encounter_id=o.encounter_id "
            + "				where 	e.voided=0 and o.voided=0 and p.voided=0 and "
            + "						e.encounter_type in (53,6) and o.concept_id in (6272,6273) and o.value_coded in (1706,1366,1709) and "
            + "						o.obs_datetime<=:startDate and e.location_id=:location "
            + "				group by p.patient_id "
            + "				union "
            + "				select person_id as patient_id,death_date as data_estado "
            + "				from person "
            + "				where dead=1 and death_date is not null and death_date<=:startDate "
            + "				union "
            + "				select 	p.patient_id, "
            + "						max(obsObito.obs_datetime) data_estado "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "						inner join obs obsObito on e.encounter_id=obsObito.encounter_id "
            + "				where 	e.voided=0 and p.voided=0 and obsObito.voided=0 and "
            + "						e.encounter_type in (21,36,37) and  e.encounter_datetime<=:startDate and  e.location_id=:location and "
            + "						obsObito.concept_id in (2031,23944,23945) and obsObito.value_coded=1366 "
            + "				group by p.patient_id "
            + "			) allSaida "
            + "		group by patient_id "
            + "	) saida on consultaLevantamento.patient_id=saida.patient_id "
            + "	where 	consultaLevantamento.data_proxima_consulta between :startDate and :endDate and "
            + "			gravida.patient_id is null and "
            + "			carga_viral.patient_id is null and "
            + "			(saida.patient_id is null or (saida.patient_id is not null and maxConsultaLeva.ultimoLevConsulta>saida.data_estado)) and "
            + "			timestampdiff(month,inicio_real.data_inicio,:endDate)>= 6 "
            + ") marcadoVisita "
            + "left join "
            + "( "
            + "	Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime data_consulta,min(o.value_datetime) proxima_consulta "
            + "	from "
            + "		(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "			from 	encounter e "
            + "					inner join patient p on p.patient_id=e.patient_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_type in (6,9) and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "			group by p.patient_id "
            + "		) ultimavisita "
            + "		inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "		left join obs o on o.encounter_id=e.encounter_id and o.concept_id=1410 and o.voided=0 "
            + "	where  	e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "			e.encounter_type in (6,9) and e.location_id=:location "
            + "	group by ultimavisita.patient_id "
            + ") consulta on marcadoVisita.patient_id=consulta.patient_id "
            + "left join "
            + "( "
            + "	Select 	ultimavisita.patient_id,ultimavisita.encounter_datetime data_levantamento_fila ,min(o.value_datetime) proximo_levantamento_fila "
            + "	from "
            + "		(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "			from 	encounter e "
            + "					inner join patient p on p.patient_id=e.patient_id "
            + "			where 	e.voided=0 and p.voided=0 and e.encounter_type=18 and e.location_id=:location and e.encounter_datetime<=:startDate "
            + "			group by p.patient_id "
            + "		) ultimavisita "
            + "		inner join encounter e on e.patient_id=ultimavisita.patient_id "
            + "		inner join obs o on o.encounter_id=e.encounter_id "
            + "	where 	o.concept_id=5096 and o.voided=0 and e.encounter_datetime=ultimavisita.encounter_datetime and "
            + "			e.encounter_type=18 and e.location_id=:location "
            + "	group by ultimavisita.patient_id "
            + ")levantamento on marcadoVisita.patient_id=levantamento.patient_id "
            + "left join "
            + "( "
            + "	Select 	p.patient_id,max(value_datetime) data_levantamento_recepcao,(max(value_datetime) + INTERVAL 30 day) proximo_levantamento_recepcao "
            + "	from 	patient p "
            + "			inner join encounter e on p.patient_id=e.patient_id "
            + "			inner join obs o on e.encounter_id=o.encounter_id "
            + "	where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 and "
            + "			o.concept_id=23866 and o.value_datetime is not null and "
            + "			o.value_datetime<=:startDate and e.location_id=:location "
            + "	group by p.patient_id "
            + ") levantamentoRecepcao on marcadoVisita.patient_id=levantamentoRecepcao.patient_id "
            + "left join "
            + "( "
            + "	select maxCargaViral.patient_id,maxCargaViral.data_carga,if(o.concept_id=856,if(o.value_numeric<=0,'Indetectavel',o.value_numeric),'Indetectavel') valor_carga "
            + "	from "
            + "	( "
            + "		Select 	p.patient_id,max(o.obs_datetime) data_carga "
            + "		from 	patient p "
            + "				inner join encounter e on p.patient_id=e.patient_id "
            + "				inner join obs o on e.encounter_id=o.encounter_id "
            + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and "
            + "				o.concept_id in (856,1305) and "
            + "				o.obs_datetime<=:startDate and e.location_id=:location "
            + "		group by p.patient_id "
            + "	) maxCargaViral "
            + "	inner join obs o on maxCargaViral.patient_id=o.person_id and maxCargaViral.data_carga=o.obs_datetime and o.voided=0 and o.concept_id in (856,1305) and o.location_id=:location "
            + ") ultimaCarga on marcadoVisita.patient_id=ultimaCarga.patient_id "
            + "left join "
            + "( "
            + "	select altacv.patient_id, count(distinct e.encounter_id) nrapss "
            + "	from "
            + "	( "
            + "		select maxCargaViral.patient_id,maxCargaViral.data_carga,o.value_numeric valor_carga "
            + "		from "
            + "		( "
            + "			Select 	p.patient_id,max(o.obs_datetime) data_carga "
            + "			from 	patient p "
            + "					inner join encounter e on p.patient_id=e.patient_id "
            + "					inner join obs o on e.encounter_id=o.encounter_id "
            + "			where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (13,6,9,53,51) and "
            + "					o.concept_id in (856,1305) and "
            + "					o.obs_datetime<=:startDate and e.location_id=:location "
            + "			group by p.patient_id "
            + "		) maxCargaViral "
            + "		inner join obs o on maxCargaViral.patient_id=o.person_id and maxCargaViral.data_carga=o.obs_datetime and o.voided=0 and "
            + "					o.concept_id=856 and o.value_numeric>=1000 and o.location_id=:location "
            + "	) altacv "
            + "	inner join encounter e on altacv.patient_id=e.patient_id "
            + "	where e.voided=0 and e.encounter_datetime between altacv.data_carga and :startDate "
            + "			and e.encounter_type=35 and e.location_id=:location "
            + "	group by altacv.patient_id "
            + ") sessoesApss on marcadoVisita.patient_id=sessoesApss.patient_id "
            + "left join "
            + "( "
            + "	select maxLinha.patient_id,maxLinha.data_linha,if(o.value_coded=21150,'1ª Linha',if(o.value_coded=21148,'2ª Linha','3ª Linha')) valorLinha "
            + "	from "
            + "	( "
            + "		Select 	p.patient_id,max(o.obs_datetime) data_linha "
            + "		from 	patient p "
            + "				inner join encounter e on p.patient_id=e.patient_id "
            + "				inner join obs o on e.encounter_id=o.encounter_id "
            + "		where 	p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type in (6,9) and "
            + "				o.concept_id=21151 and o.obs_datetime<=:startDate and e.location_id=:location "
            + "		group by p.patient_id "
            + "	) maxLinha "
            + "	inner join obs o on maxLinha.patient_id=o.person_id and maxLinha.data_linha=o.obs_datetime and o.voided=0 and o.concept_id=21151 and o.location_id=:location "
            + ") linha on marcadoVisita.patient_id=linha.patient_id "
            + "left join "
            + "( "
            + "	select 	ultimo_lev.patient_id, "
            + "			case o.value_coded "
            + "			when 1703 then 'AZT+3TC+EFV' "
            + "			when 6100 then 'AZT+3TC+LPV/r' "
            + "			when 1651 then 'AZT+3TC+NVP' "
            + "			when 6324 then 'TDF+3TC+EFV' "
            + "			when 6104 then 'ABC+3TC+EFV' "
            + "			when 23784 then 'TDF+3TC+DTG' "
            + "			when 23786 then 'ABC+3TC+DTG' "
            + "			when 23785 then 'TDF+3TC+DTG' "
            + "			when 6116 then 'AZT+3TC+ABC' "
            + "			when 6106 then 'ABC+3TC+LPV/r' "
            + "			when 6105 then 'ABC+3TC+NVP' "
            + "			when 6108 then 'TDF+3TC+LPV/r' "
            + "			when 23790 then 'TDF+3TC+LPV/r+RTV' "
            + "			when 23791 then 'TDF+3TC+ATV/r' "
            + "			when 23792 then 'ABC+3TC+ATV/r' "
            + "			when 23793 then 'AZT+3TC+ATV/r' "
            + "			when 23795 then 'ABC+3TC+ATV/r+RAL' "
            + "			when 23796 then 'TDF+3TC+ATV/r+RAL' "
            + "			when 23801 then 'AZT+3TC+RAL' "
            + "			when 23802 then 'AZT+3TC+DRV/r' "
            + "			when 23815 then 'AZT+3TC+DTG' "
            + "			when 6329 then 'TDF+3TC+RAL+DRV/r' "
            + "			when 23797 then 'ABC+3TC+DRV/r+RAL' "
            + "			when 23798 then '3TC+RAL+DRV/r' "
            + "			when 23803 then 'AZT+3TC+RAL+DRV/r' "
            + "			when 6243 then 'TDF+3TC+NVP' "
            + "			when 6103 then 'D4T+3TC+LPV/r' "
            + "			when 792 then 'D4T+3TC+NVP' "
            + "			when 1827 then 'D4T+3TC+EFV' "
            + "			when 6102 then 'D4T+3TC+ABC' "
            + "			when 1311 then 'ABC+3TC+LPV/r' "
            + "			when 1312 then 'ABC+3TC+NVP' "
            + "			when 1313 then 'ABC+3TC+EFV' "
            + "			when 1314 then 'AZT+3TC+LPV/r' "
            + "			when 1315 then 'TDF+3TC+EFV' "
            + "			when 6330 then 'AZT+3TC+RAL+DRV/r' "
            + "			when 6325 then 'D4T+3TC+ABC+LPV/r' "
            + "			when 6326 then 'AZT+3TC+ABC+LPV/r' "
            + "			when 6327 then 'D4T+3TC+ABC+EFV' "
            + "			when 6328 then 'AZT+3TC+ABC+EFV' "
            + "			when 6109 then 'AZT+DDI+LPV/r' "
            + "			when 21163 then 'AZT+3TC+LPV/r' "
            + "			when 23799 then 'TDF+3TC+DTG' "
            + "			when 23800 then 'ABC+3TC+DTG' "
            + "			when 6110 then 'D4T20+3TC+NVP' "
            + "			when 1702 then 'AZT+3TC+NFV' "
            + "			when 817  then 'AZT+3TC+ABC' "
            + "			when 6244 then 'AZT+3TC+RTV' "
            + "			when 1700 then 'AZT+DDl+NFV' "
            + "			when 633  then 'EFV' "
            + "			when 625  then 'D4T' "
            + "			when 631  then 'NVP' "
            + "			when 628  then '3TC' "
            + "			when 635  then 'NFV' "
            + "			when 797  then 'AZT' "
            + "			when 814  then 'ABC' "
            + "			when 6107 then 'TDF+AZT+3TC+LPV/r' "
            + "			when 6236 then 'D4T+DDI+RTV-IP' "
            + "			when 1701 then 'ABC+DDI+NFV' "
            + "			when 6114 then '3DFC' "
            + "			when 6115 then '2DFC+EFV' "
            + "			when 6233 then 'AZT+3TC+DDI+LPV' "
            + "			when 6234 then 'ABC+TDF+LPV' "
            + "			when 6242 then 'D4T+DDI+NVP' "
            + "			when 6118 then 'DDI50+ABC+LPV' "
            + "			else 'OUTRO' end as ultimo_regime, "
            + "			ultimo_lev.encounter_datetime data_regime "
            + "	from 	obs o, "
            + "			(	select p.patient_id,max(encounter_datetime) as encounter_datetime "
            + "				from 	patient p "
            + "						inner join encounter e on p.patient_id=e.patient_id "
            + "				where 	encounter_type=18 and e.voided=0 and "
            + "						encounter_datetime <=:startDate and e.location_id=:location and p.voided=0 "
            + "				group by patient_id "
            + "			) ultimo_lev "
            + "	where 	o.person_id=ultimo_lev.patient_id and o.obs_datetime=ultimo_lev.encounter_datetime and o.voided=0 and "
            + "			o.concept_id=1088 and o.location_id=:location "
            + ") regime on marcadoVisita.patient_id=regime.patient_id "
            + "left join person_attribute pat on pat.person_id=marcadoVisita.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value <> '' and pat.voided=0 "
            + "left join "
            + "(	select pid1.* "
            + "	from patient_identifier pid1 "
            + "	inner join "
            + "		( "
            + "			select patient_id,min(patient_identifier_id) id "
            + "			from patient_identifier "
            + "			where voided=0 "
            + "			group by patient_id "
            + "		) pid2 "
            + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id "
            + ") pid on pid.patient_id=marcadoVisita.patient_id "
            + "left join "
            + "(	select pn1.* "
            + "	from person_name pn1 "
            + "	inner join "
            + "		( "
            + "			select person_id,min(person_name_id) id "
            + "			from person_name "
            + "			where voided=0 "
            + "			group by person_id "
            + "		) pn2 "
            + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id "
            + ") pn on pn.person_id=marcadoVisita.patient_id "
            + "inner join person per on per.person_id=marcadoVisita.patient_id "
            + "where marcadoVisita.data_proxima_consulta between :startDate and :endDate "
            + "group by marcadoVisita.patient_id ";
  }
}
